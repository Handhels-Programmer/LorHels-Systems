<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LorHels Systems - ERP Enterprise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
        .sidebar-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .custom-shadow { box-shadow: 0 10px 40px -10px rgba(79, 70, 229, 0.1); }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Scrollbar estilizado */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase Integration ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, setDoc, getDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDkQ95muJR8bNBHSjRXxEGNbiknTj4wKpo",
            authDomain: "lorhels-systems-a1ad4.firebaseapp.com",
            projectId: "lorhels-systems-a1ad4",
            storageBucket: "lorhels-systems-a1ad4.firebasestorage.app",
            messagingSenderId: "387342109322",
            appId: "1:387342109322:web:be3973a4f95e82881afb73",
            measurementId: "G-MPVX6KW40J"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Constants & Utilities ---
        
        const CURRENCIES = {
            'DOP': { symbol: 'RD$', label: 'Peso Dom. (DOP)' },
            'USD': { symbol: 'US$', label: 'Dólar (USD)' },
            'EUR': { symbol: '€', label: 'Euro (EUR)' }
        };

        const formatCurrency = (amount, currencyCode) => {
            const symbol = CURRENCIES[currencyCode]?.symbol || '€';
            return `${symbol}${amount?.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        };

        // --- UI Components ---

        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    iconRef.current.innerHTML = `<i data-lucide="${kebabName}" style="width: ${size}px; height: ${size}px;"></i>`;
                    window.lucide.createIcons({
                        attrs: { class: className, 'stroke-width': 2 },
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center leading-none" />;
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-3xl border border-slate-100 shadow-sm ${className}`}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = "", icon, loading = false, type = "button", disabled = false }) => {
            const styles = {
                primary: 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-indigo-100 shadow-lg',
                secondary: 'bg-white text-slate-700 border border-slate-200 hover:bg-slate-50',
                danger: 'bg-red-50 text-red-600 hover:bg-red-100',
                ghost: 'text-slate-500 hover:bg-slate-100'
            };
            return (
                <button 
                    type={type}
                    disabled={loading || disabled}
                    onClick={onClick} 
                    className={`px-5 py-2.5 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 transition-all active:scale-95 disabled:opacity-50 ${styles[variant]} ${className}`}
                >
                    {loading ? <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : (icon && <Icon name={icon} size={18} />)}
                    {children}
                </button>
            );
        };

        const Badge = ({ variant = 'default', children }) => {
            const styles = {
                success: 'bg-emerald-100 text-emerald-700',
                warning: 'bg-amber-100 text-amber-700',
                danger: 'bg-red-100 text-red-700',
                default: 'bg-slate-100 text-slate-600'
            };
            return <span className={`px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider ${styles[variant]}`}>{children}</span>;
        };

        // Helper para mostrar totales agrupados por moneda en el Dashboard
        const MultiCurrencyTotal = ({ data, valueField, defaultColor = "text-indigo-950" }) => {
            const totals = data.reduce((acc, item) => {
                const curr = item.currency || 'EUR'; // Legacy support
                acc[curr] = (acc[curr] || 0) + (parseFloat(item[valueField]) || 0);
                return acc;
            }, {});

            if (Object.keys(totals).length === 0) return <h3 className={`text-4xl font-black ${defaultColor}`}>0.00</h3>;

            return (
                <div className="flex flex-col gap-1">
                    {Object.entries(totals).map(([curr, val]) => (
                        <div key={curr} className="flex items-baseline gap-2">
                            <span className="text-[10px] font-black uppercase tracking-widest opacity-40 w-8">{curr}</span>
                            <span className={`text-2xl font-black ${defaultColor}`}>
                                {CURRENCIES[curr]?.symbol || ''}{val.toLocaleString(undefined, { minimumFractionDigits: 2 })}
                            </span>
                        </div>
                    ))}
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onClick={onClose}></div>
                    <Card className="relative w-full max-w-lg p-8 animate-slide-up shadow-2xl overflow-y-auto max-h-[90vh]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-black italic">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><Icon name="X" /></button>
                        </div>
                        {children}
                    </Card>
                </div>
            );
        };

        // --- Auth Module ---

        const LoginScreen = ({ onLogin, authLoading }) => {
            const [step, setStep] = useState(1); 
            const [selectedOrg, setSelectedOrg] = useState(null);
            const [pin, setPin] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const companies = [
                { name: "ILR MultiServices", slug: "ilr-multiservices", staticPin: "1111" },
                { name: "Handhels Inc", slug: "handhels-inc", staticPin: "2222" }
            ];

            const handlePinSubmit = (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                // Validación local inmediata
                setTimeout(() => {
                    if (pin === selectedOrg.staticPin) {
                        onLogin(selectedOrg.slug, selectedOrg.name);
                    } else {
                        setError('PIN incorrecto.');
                        setPin('');
                    }
                    setLoading(false);
                }, 400);
            };

            return (
                <div className="h-screen w-full flex items-center justify-center bg-slate-50 px-6">
                    <Card className="w-full max-w-md p-10 shadow-2xl animate-slide-up border-none">
                        <div className="flex flex-col items-center mb-10 text-center">
                            <div className="w-20 h-20 bg-indigo-600 rounded-[2rem] flex items-center justify-center shadow-2xl shadow-indigo-200 mb-6 text-white transform -rotate-6">
                                <Icon name={step === 1 ? "Briefcase" : "Lock"} size={40} />
                            </div>
                            <h1 className="text-3xl font-black italic uppercase tracking-tighter text-indigo-950">LorHels Systems</h1>
                            <p className="text-slate-400 text-xs font-bold uppercase tracking-[0.3em] mt-3 leading-none">ERP Enterprise</p>
                        </div>

                        {step === 1 ? (
                            <div className="space-y-4">
                                <p className="text-[10px] font-black uppercase text-slate-400 tracking-widest text-center mb-2">Selecciona tu Empresa</p>
                                {companies.map(c => (
                                    <button key={c.slug} onClick={() => { setSelectedOrg(c); setStep(2); }} className="w-full flex items-center justify-between p-5 bg-white border-2 border-slate-50 rounded-2xl hover:border-indigo-600 hover:bg-indigo-50/50 transition-all group text-left">
                                        <div className="flex items-center gap-4">
                                            <Icon name="Building" className="text-slate-400 group-hover:text-indigo-600 transition-colors" />
                                            <span className="font-bold text-slate-700 text-lg">{c.name}</span>
                                        </div>
                                        <Icon name="ChevronRight" size={18} className="text-slate-300 group-hover:text-indigo-600" />
                                    </button>
                                ))}
                            </div>
                        ) : (
                            <form onSubmit={handlePinSubmit} className="space-y-8">
                                <div className="text-center">
                                    <p className="text-xl font-black text-indigo-600 italic uppercase">{selectedOrg.name}</p>
                                </div>
                                <div className="space-y-4">
                                    <label className="text-[10px] font-black uppercase text-slate-400 tracking-[0.2em] block text-center">PIN de Seguridad</label>
                                    <input type="password" maxLength="4" required autoFocus value={pin} onChange={(e) => setPin(e.target.value.replace(/\D/g, ''))} className="w-full text-center text-4xl tracking-[0.8em] py-5 bg-slate-50 border-2 border-slate-100 rounded-3xl font-black outline-none focus:border-indigo-600 focus:bg-white transition-all shadow-inner" placeholder="••••" />
                                    {error && <div className="p-3 bg-red-50 text-red-600 text-xs font-bold rounded-xl text-center animate-pulse">{error}</div>}
                                </div>
                                <div className="flex gap-4">
                                    <Button variant="ghost" className="flex-grow py-4 font-bold" onClick={() => setStep(1)}>Atrás</Button>
                                    <Button type="submit" loading={loading} className="flex-grow py-4 font-bold">Entrar</Button>
                                </div>
                            </form>
                        )}
                        <p className="mt-8 text-center text-[10px] text-slate-300 font-bold uppercase tracking-widest leading-none">
                            {authLoading ? 'Conectando...' : 'Servicios de Nube Listos'}
                        </p>
                    </Card>
                </div>
            );
        };

        // --- App Principal ---

        function App() {
            const [view, setView] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [actionLoading, setActionLoading] = useState(false);
            const [syncStatus, setSyncStatus] = useState('offline'); 
            
            const [companyId, setCompanyId] = useState(localStorage.getItem('lorhels_slug') || null);
            const [companyName, setCompanyName] = useState(localStorage.getItem('lorhels_name') || '');
            const [defaultCurrency, setDefaultCurrency] = useState(localStorage.getItem('lorhels_currency') || 'DOP');
            
            const [data, setData] = useState({ invoices: [], products: [], clients: [] });
            const [modal, setModal] = useState({ open: false, type: '' });

            // REGLA 3: Autenticación antes de cualquier consulta
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try { await signInWithCustomToken(auth, __initial_auth_token); } catch (e) { await signInAnonymously(auth); }
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { console.error("Auth Fail:", e); }
                };
                initAuth();

                const unsub = onAuthStateChanged(auth, u => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            // ESTRUCTURA SEGÚN TUS REGLAS: artifacts/{companyId}/users/{userId}/{collectionName}
            // MODIFICACIÓN: Ahora usamos 'public/data' para que sea compartido por EMPRESA, no por USUARIO
            useEffect(() => {
                if (!user || !companyId) return;
                
                setSyncStatus('conectando');
                // CAMBIO: Ruta pública compartida para la empresa
                const basePath = ['artifacts', companyId, 'public', 'data'];

                const handleErr = (err) => {
                    console.error("Firestore error:", err);
                    setSyncStatus('error');
                };

                const unsubInv = onSnapshot(collection(db, ...basePath, 'invoices'), s => {
                    setData(prev => ({ ...prev, invoices: s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.timestamp - a.timestamp) }));
                    setSyncStatus('online');
                }, handleErr);

                const unsubProd = onSnapshot(collection(db, ...basePath, 'products'), s => {
                    setData(prev => ({ ...prev, products: s.docs.map(d => ({id: d.id, ...d.data()})) }));
                }, handleErr);

                const unsubCli = onSnapshot(collection(db, ...basePath, 'clients'), s => {
                    setData(prev => ({ ...prev, clients: s.docs.map(d => ({id: d.id, ...d.data()})) }));
                }, handleErr);

                return () => { unsubInv(); unsubProd(); unsubCli(); };
            }, [user, companyId]);

            const handleLogin = (slug, name) => {
                setCompanyId(slug); setCompanyName(name);
                localStorage.setItem('lorhels_slug', slug); localStorage.setItem('lorhels_name', name);
            };

            const handleLogout = () => {
                setCompanyId(null); setCompanyName('');
                localStorage.removeItem('lorhels_slug'); localStorage.removeItem('lorhels_name');
            };

            const handleCurrencyChange = (curr) => {
                setDefaultCurrency(curr);
                localStorage.setItem('lorhels_currency', curr);
            };

            const saveData = async (type, payload) => {
                if (!user || !companyId) return;
                setActionLoading(true);

                try {
                    // CAMBIO: Guardar en ruta pública compartida
                    // Path: artifacts/{companyId}/public/data/{collectionName}
                    const colRef = collection(db, 'artifacts', companyId, 'public', 'data', type + 's');
                    
                    await addDoc(colRef, {
                        ...payload,
                        createdBy: user.uid, // Guardamos quién lo creó por auditoría
                        timestamp: Date.now(),
                        date: new Date().toISOString().split('T')[0]
                    });
                    
                    setModal({ open: false, type: '' });
                } catch (err) {
                    console.error("Save error:", err);
                    alert(`Error de permisos. Asegúrate de que las reglas en Firebase permitan escribir en: artifacts/${companyId}/public/data/${type}s`);
                } finally {
                    setActionLoading(false);
                }
            };

            const deleteData = async (type, id) => {
                if (!user || !companyId) return;
                try {
                    // CAMBIO: Borrar de ruta pública compartida
                    await deleteDoc(doc(db, 'artifacts', companyId, 'public', 'data', type + 's', id));
                } catch (err) { console.error(err); }
            };

            // Calculate Stock Value for Dashboard (Stock * Price)
            const productsWithValue = useMemo(() => {
                return data.products.map(p => ({
                    ...p,
                    stockValue: (parseFloat(p.price) || 0) * (parseInt(p.stock) || 0)
                }));
            }, [data.products]);

            if (loading) return (
                <div className="h-screen flex flex-col items-center justify-center bg-white">
                    <div className="w-16 h-16 border-4 border-slate-100 border-t-indigo-600 rounded-full animate-spin mb-6"></div>
                    <p className="font-black italic text-indigo-950 uppercase tracking-tighter text-xl">LorHels Systems...</p>
                </div>
            );

            if (!companyId) return <LoginScreen onLogin={handleLogin} authLoading={!user} />;

            return (
                <div className="flex h-screen w-full relative bg-[#f8fafc]">
                    
                    {/* Sidebar */}
                    <aside className={`${sidebarOpen ? 'w-80' : 'w-24'} bg-white border-r border-slate-100 sidebar-transition flex flex-col z-30 shadow-2xl shadow-slate-200/40`}>
                        <div className="p-10 flex items-center gap-4 overflow-hidden">
                            <div className="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center flex-shrink-0 text-white shadow-xl shadow-indigo-100 transform -rotate-6">
                                <Icon name="TrendingUp" size={24} />
                            </div>
                            {sidebarOpen && <h1 className="font-black text-2xl tracking-tighter italic uppercase text-indigo-950">LorHels</h1>}
                        </div>

                        <nav className="flex-grow px-6 space-y-2">
                            {[
                                { id: 'dashboard', label: 'Dashboard', icon: 'LayoutDashboard' },
                                { id: 'invoices', label: 'Facturación', icon: 'FileText' },
                                { id: 'inventory', label: 'Inventario', icon: 'Package' },
                                { id: 'clients', label: 'Clientes', icon: 'Users' },
                                { id: 'settings', label: 'Configuración', icon: 'Settings' }
                            ].map(item => (
                                <button key={item.id} onClick={() => setView(item.id)} className={`w-full flex items-center gap-4 px-5 py-4 rounded-2xl transition-all group ${view === item.id ? 'bg-indigo-600 text-white shadow-2xl shadow-indigo-200' : 'text-slate-400 hover:bg-indigo-50 hover:text-indigo-600'}`}>
                                    <Icon name={item.icon} size={22} className={view === item.id ? 'scale-110' : 'group-hover:scale-110'} />
                                    {sidebarOpen && <span className="font-bold text-sm tracking-tight">{item.label}</span>}
                                </button>
                            ))}
                        </nav>

                        <div className="p-8 space-y-4">
                            <button onClick={handleLogout} className="w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-red-400 hover:bg-red-50 transition-all font-bold text-sm">
                                <Icon name="LogOut" size={20} /> {sidebarOpen && "Salir Empresa"}
                            </button>
                            <button onClick={() => setSidebarOpen(!sidebarOpen)} className="w-full flex items-center justify-center p-4 bg-slate-50 rounded-2xl text-slate-400 hover:text-indigo-600 transition-all">
                                <Icon name="ChevronRight" size={24} className={sidebarOpen ? 'rotate-180' : ''} />
                            </button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-grow flex flex-col overflow-hidden">
                        <header className="h-28 glass border-b border-slate-100 flex items-center justify-between px-12 sticky top-0 z-20">
                            <div>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 leading-none">Cloud Infrastructure Node</p>
                                <div className="flex items-center gap-2 mt-1">
                                    <div className={`w-2.5 h-2.5 rounded-full animate-pulse shadow-[0_0_10px_rgba(79,70,229,0.5)] ${syncStatus === 'online' ? 'bg-emerald-500' : syncStatus === 'error' ? 'bg-red-500' : 'bg-amber-500'}`}></div>
                                    <p className="text-2xl font-black text-slate-800 uppercase italic leading-none">{companyName}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-6">
                                <div className="text-right hidden sm:block">
                                    <p className="text-[10px] font-black uppercase text-indigo-600 tracking-widest leading-none mb-1">Sesión Segura</p>
                                    <p className="text-xs font-bold text-slate-400 font-mono truncate w-32">{user?.uid.slice(0,12)}...</p>
                                </div>
                                <div className="w-14 h-14 rounded-2xl bg-indigo-50 border-2 border-white shadow-xl overflow-hidden cursor-pointer hover:scale-105 transition-transform">
                                    <img src={`https://api.dicebear.com/7.x/shapes/svg?seed=${user?.uid}`} alt="Avatar" />
                                </div>
                            </div>
                        </header>

                        <div className="flex-grow overflow-y-auto p-12 custom-shadow">
                            <div className="max-w-7xl mx-auto pb-20">
                                
                                {view === 'dashboard' && (
                                    <div className="space-y-8 animate-slide-up">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                                            <Card className="p-8 border-l-8 border-indigo-600 transform hover:-translate-y-1 transition-all">
                                                <p className="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-2">Ingresos Consolidados</p>
                                                <MultiCurrencyTotal data={data.invoices} valueField="total" defaultColor="text-indigo-950" />
                                            </Card>
                                            <Card className="p-8 border-l-8 border-emerald-600 transform hover:-translate-y-1 transition-all">
                                                <p className="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-2">Clientes en Mi Perfil</p>
                                                <h3 className="text-4xl font-black text-emerald-950">{data.clients.length}</h3>
                                            </Card>
                                            <Card className="p-8 border-l-8 border-amber-600 transform hover:-translate-y-1 transition-all">
                                                <p className="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-2">Valor de Stock</p>
                                                <MultiCurrencyTotal data={productsWithValue} valueField="stockValue" defaultColor="text-amber-950" />
                                            </Card>
                                        </div>

                                        <Card className="p-10">
                                            <div className="flex justify-between items-center mb-10 text-indigo-950">
                                                <h3 className="text-2xl font-black italic uppercase">Mi Actividad Reciente</h3>
                                                <Badge variant={syncStatus === 'online' ? 'success' : 'warning'}>
                                                    {syncStatus === 'online' ? 'Sincronizado' : 'Conectando Firestore...'}
                                                </Badge>
                                            </div>
                                            <div className="space-y-6">
                                                {data.invoices.slice(0, 5).map(inv => (
                                                    <div key={inv.id} className="flex items-center justify-between p-5 bg-slate-50 rounded-3xl border border-transparent hover:border-indigo-100 hover:bg-white transition-all group">
                                                        <div className="flex items-center gap-5">
                                                            <div className="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-indigo-600 shadow-sm border border-slate-100 group-hover:bg-indigo-600 group-hover:text-white transition-all"><Icon name="FileText" /></div>
                                                            <div>
                                                                <p className="font-black text-slate-800 uppercase tracking-tight">{inv.clientName}</p>
                                                                <div className="flex items-center gap-2 text-[10px] text-slate-400 font-bold uppercase">
                                                                    <span>{inv.date}</span>
                                                                    <span className="w-1 h-1 bg-slate-300 rounded-full"></span>
                                                                    <span className="text-indigo-400">{inv.currency || 'EUR'}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="text-right flex items-center gap-6">
                                                            <p className="font-black text-xl text-indigo-600 tracking-tighter">
                                                                {formatCurrency(inv.total, inv.currency || 'EUR')}
                                                            </p>
                                                            <button onClick={() => deleteData('invoice', inv.id)} className="p-2 text-slate-200 hover:text-red-500 transition-colors"><Icon name="Trash2" size={18} /></button>
                                                        </div>
                                                    </div>
                                                ))}
                                                {data.invoices.length === 0 && <div className="text-center py-20 opacity-30 italic font-medium">No hay registros almacenados en tu perfil de {companyName}.</div>}
                                            </div>
                                        </Card>
                                    </div>
                                )}

                                {view === 'clients' && (
                                    <div className="space-y-8 animate-slide-up">
                                        <div className="flex justify-between items-end">
                                            <div>
                                                <h2 className="text-4xl font-black italic text-indigo-950">Mis Clientes</h2>
                                                <p className="text-slate-500 font-medium mt-1 uppercase text-[10px] tracking-widest">Base de datos de usuario en {companyName}</p>
                                            </div>
                                            <Button icon="Plus" onClick={() => setModal({ open: true, type: 'client' })}>Nuevo Cliente</Button>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                            {data.clients.map(c => (
                                                <Card key={c.id} className="p-8 group hover:border-indigo-200 transition-all transform hover:-translate-y-1 relative">
                                                    <div className="flex justify-between items-start mb-6">
                                                        <div className="w-16 h-16 bg-slate-100 rounded-[1.5rem] flex items-center justify-center font-black text-3xl text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition-all transform -rotate-6">
                                                            {c.name?.charAt(0)}
                                                        </div>
                                                        <button onClick={() => deleteData('client', c.id)} className="p-2 text-slate-200 hover:text-red-500 transition-colors"><Icon name="Trash2" /></button>
                                                    </div>
                                                    <h4 className="font-black text-xl text-indigo-950 mb-1 leading-tight">{c.name}</h4>
                                                    <p className="text-xs font-black text-indigo-600 mb-6 bg-indigo-50 inline-block px-3 py-1 rounded-lg tracking-tighter">RNC: {c.rnc}</p>
                                                    <div className="space-y-3 mb-8 text-[11px] text-slate-500 font-bold tracking-tight">
                                                        <div className="flex items-center gap-3"><Icon name="Mail" size={14} className="text-indigo-300"/> <span className="truncate">{c.email}</span></div>
                                                        <div className="flex items-center gap-3"><Icon name="Phone" size={14} className="text-indigo-300"/> <span>{c.phone}</span></div>
                                                        <div className="flex items-center gap-3"><Icon name="MapPin" size={14} className="text-indigo-300"/> <span className="truncate">{c.address}</span></div>
                                                    </div>
                                                    <div className="pt-6 border-t border-slate-50 flex justify-between items-center">
                                                        <div><p className="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-1 leading-none">Límite Crédito</p><p className="text-lg font-black text-emerald-600 tracking-tighter leading-none">€{c.creditLimit?.toLocaleString()}</p></div>
                                                        <Badge variant="success">Activo</Badge>
                                                    </div>
                                                </Card>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {view === 'settings' && (
                                    <div className="max-w-2xl animate-slide-up space-y-8">
                                        <h2 className="text-4xl font-black italic text-indigo-950">Ajustes</h2>
                                        <Card className="p-10">
                                            <div className="flex items-center gap-4 mb-8">
                                                <div className="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center"><Icon name="Shield" /></div>
                                                <div>
                                                    <h4 className="font-black text-xl text-indigo-950">Seguridad de Perfil</h4>
                                                    <p className="text-sm text-slate-400 font-bold">Protocolos activos para {companyName}</p>
                                                </div>
                                            </div>
                                            <div className="p-6 bg-slate-50 rounded-2xl space-y-3 border-2 border-slate-100 font-bold mb-8">
                                                <div className="flex justify-between items-center"><span className="text-xs text-slate-400 uppercase tracking-widest">ID Empresa:</span><span className="text-indigo-600 font-mono">{companyId}</span></div>
                                                <div className="flex justify-between items-center"><span className="text-xs text-slate-400 uppercase tracking-widest">UID Usuario:</span><span className="text-slate-600 font-mono text-[10px]">{user?.uid}</span></div>
                                                <div className="flex justify-between items-center"><span className="text-xs text-slate-400 uppercase tracking-widest">Entorno:</span><span className="text-indigo-600 uppercase bg-indigo-50 px-2 py-1 rounded-lg text-[10px]">Global (Empresarial)</span></div>
                                            </div>

                                            <div className="flex items-center gap-4 mb-4">
                                                <div className="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center"><Icon name="Coins" /></div>
                                                <div>
                                                    <h4 className="font-black text-xl text-indigo-950">Preferencia de Moneda</h4>
                                                    <p className="text-sm text-slate-400 font-bold">Moneda por defecto para nuevos registros</p>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-3 gap-4">
                                                {Object.entries(CURRENCIES).map(([code, details]) => (
                                                    <button 
                                                        key={code}
                                                        onClick={() => handleCurrencyChange(code)}
                                                        className={`p-4 rounded-xl font-bold border-2 transition-all ${defaultCurrency === code ? 'border-emerald-500 bg-emerald-50 text-emerald-700' : 'border-slate-100 bg-white text-slate-400 hover:border-slate-200'}`}
                                                    >
                                                        <div className="text-2xl mb-1">{details.symbol}</div>
                                                        <div className="text-xs uppercase tracking-wider">{code}</div>
                                                    </button>
                                                ))}
                                            </div>
                                        </Card>
                                    </div>
                                )}

                                {['invoices', 'inventory'].includes(view) && (
                                    <div className="space-y-8 animate-slide-up">
                                        <div className="flex justify-between items-end">
                                            <div>
                                                <h2 className="text-4xl font-black italic text-indigo-950 capitalize">{view === 'invoices' ? 'Facturación' : 'Inventario'}</h2>
                                                <p className="text-slate-500 font-medium mt-1 uppercase text-xs tracking-widest">Gestión privada para {companyName}</p>
                                            </div>
                                            <Button icon="Plus" onClick={() => setModal({ open: true, type: view === 'invoices' ? 'invoice' : 'product' })}>
                                                Añadir Registro
                                            </Button>
                                        </div>
                                        
                                        {/* Vista de Listado para Facturas/Inventario */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            {view === 'invoices' && data.invoices.map(inv => (
                                                <Card key={inv.id} className="p-6 relative overflow-hidden group hover:-translate-y-1 transition-transform">
                                                    <div className="absolute top-0 right-0 p-4 opacity-10 font-black text-6xl rotate-12 group-hover:scale-110 transition-transform select-none">
                                                        {CURRENCIES[inv.currency || 'EUR']?.symbol}
                                                    </div>
                                                    <div className="relative z-10">
                                                        <div className="flex justify-between items-start mb-4">
                                                            <div className="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center"><Icon name="FileText" size={18} /></div>
                                                            <Badge variant={inv.status === 'pagada' ? 'success' : 'default'}>{inv.status || 'Pendiente'}</Badge>
                                                        </div>
                                                        <h4 className="font-bold text-lg text-slate-800 mb-1">{inv.clientName}</h4>
                                                        <p className="text-xs text-slate-400 font-bold mb-4">{inv.date}</p>
                                                        <div className="pt-4 border-t border-slate-50 flex justify-between items-end">
                                                            <div className="flex flex-col">
                                                                <span className="text-[10px] uppercase font-black text-slate-300 tracking-widest">Total</span>
                                                                <span className="text-2xl font-black text-indigo-600">{formatCurrency(inv.total, inv.currency || 'EUR')}</span>
                                                            </div>
                                                            <button onClick={() => deleteData('invoice', inv.id)} className="text-slate-300 hover:text-red-500 transition-colors"><Icon name="Trash2" size={18} /></button>
                                                        </div>
                                                    </div>
                                                </Card>
                                            ))}

                                            {view === 'inventory' && data.products.map(prod => (
                                                 <Card key={prod.id} className="p-6 relative overflow-hidden group hover:-translate-y-1 transition-transform">
                                                    <div className="relative z-10">
                                                        <div className="flex justify-between items-start mb-4">
                                                            <div className="w-10 h-10 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center"><Icon name="Package" size={18} /></div>
                                                            <div className="bg-slate-100 text-slate-600 px-2 py-1 rounded-lg text-xs font-bold">x{prod.stock}</div>
                                                        </div>
                                                        <h4 className="font-bold text-lg text-slate-800 mb-1">{prod.name}</h4>
                                                        <div className="pt-4 border-t border-slate-50 flex justify-between items-end mt-4">
                                                            <div className="flex flex-col">
                                                                <span className="text-[10px] uppercase font-black text-slate-300 tracking-widest">Precio Unit.</span>
                                                                <span className="text-xl font-black text-amber-600">{formatCurrency(prod.price, prod.currency || 'EUR')}</span>
                                                            </div>
                                                            <button onClick={() => deleteData('product', prod.id)} className="text-slate-300 hover:text-red-500 transition-colors"><Icon name="Trash2" size={18} /></button>
                                                        </div>
                                                    </div>
                                                </Card>
                                            ))}
                                        </div>

                                        {((view === 'invoices' && data.invoices.length === 0) || (view === 'inventory' && data.products.length === 0)) && (
                                            <Card className="py-40 text-center opacity-20 border-dashed border-4 border-indigo-200">
                                                <Icon name={view === 'invoices' ? 'FileText' : 'Package'} size={100} className="mx-auto mb-6 text-indigo-300" />
                                                <p className="text-3xl font-black italic uppercase tracking-tighter">Base de Datos Vacía</p>
                                                <p className="text-sm font-bold opacity-60">Los datos que añadas serán visibles para toda la organización.</p>
                                            </Card>
                                        )}
                                    </div>
                                )}

                            </div>
                        </div>
                    </main>

                    {/* Modales */}
                    <Modal 
                        isOpen={modal.open} 
                        onClose={() => setModal({ open: false, type: '' })} 
                        title={`Nuevo Registro`}
                    >
                        <form className="space-y-6" onSubmit={(e) => {
                            e.preventDefault();
                            const fd = new FormData(e.target);
                            const payload = Object.fromEntries(fd.entries());
                            
                            if(payload.total) payload.total = parseFloat(payload.total) || 0;
                            if(payload.price) payload.price = parseFloat(payload.price) || 0;
                            if(payload.stock) payload.stock = parseInt(payload.stock) || 0;
                            if(payload.creditLimit) payload.creditLimit = parseFloat(payload.creditLimit) || 0;
                            
                            saveData(modal.type, payload);
                        }}>
                            {modal.type === 'client' && (
                                <div className="space-y-4">
                                    <input name="name" className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Nombre de la empresa" required />
                                    <div className="grid grid-cols-2 gap-4">
                                        <input name="rnc" className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="RNC" required />
                                        <input name="phone" className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Contacto" required />
                                    </div>
                                    <input name="email" type="email" className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Email" required />
                                    <input name="address" className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Dirección" required />
                                    <input name="creditLimit" type="number" step="0.01" className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Límite Crédito (€)" required />
                                </div>
                            )}

                            {modal.type === 'invoice' && (
                                <div className="space-y-4">
                                    <select name="clientName" className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" required>
                                        <option value="">Selecciona Cliente...</option>
                                        {data.clients.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                                        {data.clients.length === 0 && <option value="Cliente Genérico">Cliente Genérico</option>}
                                    </select>
                                    <div className="grid grid-cols-3 gap-4">
                                        <select name="currency" defaultValue={defaultCurrency} className="col-span-1 p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner">
                                            {Object.entries(CURRENCIES).map(([code, details]) => (
                                                <option key={code} value={code}>{code}</option>
                                            ))}
                                        </select>
                                        <input name="total" type="number" step="0.01" className="col-span-2 w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Monto Total" required />
                                    </div>
                                    <input type="hidden" name="status" value="pendiente" />
                                </div>
                            )}

                            {modal.type === 'product' && (
                                <div className="space-y-4">
                                    <input name="name" className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Descripción del Item" required />
                                    <div className="grid grid-cols-2 gap-4">
                                        <select name="currency" defaultValue={defaultCurrency} className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner">
                                            {Object.entries(CURRENCIES).map(([code, details]) => (
                                                <option key={code} value={code}>{details.label}</option>
                                            ))}
                                        </select>
                                        <input name="stock" type="number" className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Stock" required />
                                    </div>
                                    <input name="price" type="number" step="0.01" className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Precio Unitario" required />
                                </div>
                            )}

                            <div className="flex gap-4 pt-6 border-t border-slate-100">
                                <Button variant="ghost" className="flex-grow font-black uppercase italic" onClick={() => setModal({ open: false, type: '' })}>Cancelar</Button>
                                <Button className="flex-grow font-black uppercase italic" type="submit" loading={actionLoading}>Confirmar</Button>
                            </div>
                        </form>
                    </Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LorHels Systems - ERP Enterprise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
        .sidebar-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .custom-shadow { box-shadow: 0 10px 40px -10px rgba(79, 70, 229, 0.1); }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Scrollbar estilizado */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase Integration ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, setDoc, getDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDkQ95muJR8bNBHSjRXxEGNbiknTj4wKpo",
            authDomain: "lorhels-systems-a1ad4.firebaseapp.com",
            projectId: "lorhels-systems-a1ad4",
            storageBucket: "lorhels-systems-a1ad4.firebasestorage.app",
            messagingSenderId: "387342109322",
            appId: "1:387342109322:web:be3973a4f95e82881afb73",
            measurementId: "G-MPVX6KW40J"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Constants & Utilities ---
        
        const CURRENCIES = {
            'DOP': { symbol: 'RD$', label: 'Peso Dom. (DOP)' },
            'USD': { symbol: 'US$', label: 'Dólar (USD)' },
            'EUR': { symbol: '€', label: 'Euro (EUR)' }
        };

        const CLIENT_TYPES = {
            'fiscal': { label: 'Valor Fiscal', color: 'bg-indigo-50 text-indigo-700 border border-indigo-100' },
            'final': { label: 'Consumidor Final', color: 'bg-slate-50 text-slate-600 border border-slate-100' },
            'government': { label: 'Gubernamental', color: 'bg-amber-50 text-amber-700 border border-amber-100' },
            'special': { label: 'Régimen Tributario', color: 'bg-purple-50 text-purple-700 border border-purple-100' }
        };

        const DOC_TYPES = {
            'rnc': 'RNC',
            'cedula': 'Cédula',
            'passport': 'Pasaporte',
            'na': 'N/A'
        };

        const formatCurrency = (amount, currencyCode) => {
            const symbol = CURRENCIES[currencyCode]?.symbol || '€';
            return `${symbol}${amount?.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        };

        // --- UI Components ---

        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    iconRef.current.innerHTML = `<i data-lucide="${kebabName}" style="width: ${size}px; height: ${size}px;"></i>`;
                    window.lucide.createIcons({
                        attrs: { class: className, 'stroke-width': 2 },
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center leading-none" />;
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-3xl border border-slate-100 shadow-sm ${className}`}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = "", icon, loading = false, type = "button", disabled = false }) => {
            const styles = {
                primary: 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-indigo-100 shadow-lg',
                secondary: 'bg-white text-slate-700 border border-slate-200 hover:bg-slate-50',
                danger: 'bg-red-50 text-red-600 hover:bg-red-100',
                ghost: 'text-slate-500 hover:bg-slate-100'
            };
            return (
                <button 
                    type={type}
                    disabled={loading || disabled}
                    onClick={onClick} 
                    className={`px-5 py-2.5 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 transition-all active:scale-95 disabled:opacity-50 ${styles[variant]} ${className}`}
                >
                    {loading ? <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : (icon && <Icon name={icon} size={18} />)}
                    {children}
                </button>
            );
        };

        const Badge = ({ variant = 'default', children }) => {
            const styles = {
                success: 'bg-emerald-100 text-emerald-700',
                warning: 'bg-amber-100 text-amber-700',
                danger: 'bg-red-100 text-red-700',
                default: 'bg-slate-100 text-slate-600'
            };
            return <span className={`px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider ${styles[variant]}`}>{children}</span>;
        };

        // Helper para mostrar totales agrupados por moneda en el Dashboard
        const MultiCurrencyTotal = ({ data, valueField, defaultColor = "text-indigo-950" }) => {
            const totals = data.reduce((acc, item) => {
                const curr = item.currency || 'EUR'; // Legacy support
                acc[curr] = (acc[curr] || 0) + (parseFloat(item[valueField]) || 0);
                return acc;
            }, {});

            if (Object.keys(totals).length === 0) return <h3 className={`text-4xl font-black ${defaultColor}`}>0.00</h3>;

            return (
                <div className="flex flex-col gap-1">
                    {Object.entries(totals).map(([curr, val]) => (
                        <div key={curr} className="flex items-baseline gap-2">
                            <span className="text-[10px] font-black uppercase tracking-widest opacity-40 w-8">{curr}</span>
                            <span className={`text-2xl font-black ${defaultColor}`}>
                                {CURRENCIES[curr]?.symbol || ''}{val.toLocaleString(undefined, { minimumFractionDigits: 2 })}
                            </span>
                        </div>
                    ))}
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onClick={onClose}></div>
                    <Card className="relative w-full max-w-lg p-8 animate-slide-up shadow-2xl overflow-y-auto max-h-[90vh]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-black italic">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><Icon name="X" /></button>
                        </div>
                        {children}
                    </Card>
                </div>
            );
        };

        // --- Auth Module ---

        const LoginScreen = ({ onLogin, authLoading }) => {
            const [step, setStep] = useState(1); 
            const [selectedOrg, setSelectedOrg] = useState(null);
            const [pin, setPin] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const companies = [
                { name: "ILR MultiServices", slug: "ilr-multiservices", staticPin: "1111" },
                { name: "Handhels Inc", slug: "handhels-inc", staticPin: "2222" }
            ];

            const handlePinSubmit = (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                // Validación local inmediata
                setTimeout(() => {
                    if (pin === selectedOrg.staticPin) {
                        onLogin(selectedOrg.slug, selectedOrg.name);
                    } else {
                        setError('PIN incorrecto.');
                        setPin('');
                    }
                    setLoading(false);
                }, 400);
            };

            return (
                <div className="h-screen w-full flex items-center justify-center bg-slate-50 px-6">
                    <Card className="w-full max-w-md p-10 shadow-2xl animate-slide-up border-none">
                        <div className="flex flex-col items-center mb-10 text-center">
                            <div className="w-20 h-20 bg-indigo-600 rounded-[2rem] flex items-center justify-center shadow-2xl shadow-indigo-200 mb-6 text-white transform -rotate-6">
                                <Icon name={step === 1 ? "Briefcase" : "Lock"} size={40} />
                            </div>
                            <h1 className="text-3xl font-black italic uppercase tracking-tighter text-indigo-950">LorHels Systems</h1>
                            <p className="text-slate-400 text-xs font-bold uppercase tracking-[0.3em] mt-3 leading-none">ERP Enterprise</p>
                        </div>

                        {step === 1 ? (
                            <div className="space-y-4">
                                <p className="text-[10px] font-black uppercase text-slate-400 tracking-widest text-center mb-2">Selecciona tu Empresa</p>
                                {companies.map(c => (
                                    <button key={c.slug} onClick={() => { setSelectedOrg(c); setStep(2); }} className="w-full flex items-center justify-between p-5 bg-white border-2 border-slate-50 rounded-2xl hover:border-indigo-600 hover:bg-indigo-50/50 transition-all group text-left">
                                        <div className="flex items-center gap-4">
                                            <Icon name="Building" className="text-slate-400 group-hover:text-indigo-600 transition-colors" />
                                            <span className="font-bold text-slate-700 text-lg">{c.name}</span>
                                        </div>
                                        <Icon name="ChevronRight" size={18} className="text-slate-300 group-hover:text-indigo-600" />
                                    </button>
                                ))}
                            </div>
                        ) : (
                            <form onSubmit={handlePinSubmit} className="space-y-8">
                                <div className="text-center">
                                    <p className="text-xl font-black text-indigo-600 italic uppercase">{selectedOrg.name}</p>
                                </div>
                                <div className="space-y-4">
                                    <label className="text-[10px] font-black uppercase text-slate-400 tracking-[0.2em] block text-center">PIN de Seguridad</label>
                                    <input type="password" maxLength="4" required autoFocus value={pin} onChange={(e) => setPin(e.target.value.replace(/\D/g, ''))} className="w-full text-center text-4xl tracking-[0.8em] py-5 bg-slate-50 border-2 border-slate-100 rounded-3xl font-black outline-none focus:border-indigo-600 focus:bg-white transition-all shadow-inner" placeholder="••••" />
                                    {error && <div className="p-3 bg-red-50 text-red-600 text-xs font-bold rounded-xl text-center animate-pulse">{error}</div>}
                                </div>
                                <div className="flex gap-4">
                                    <Button variant="ghost" className="flex-grow py-4 font-bold" onClick={() => setStep(1)}>Atrás</Button>
                                    <Button type="submit" loading={loading} className="flex-grow py-4 font-bold">Entrar</Button>
                                </div>
                            </form>
                        )}
                        <p className="mt-8 text-center text-[10px] text-slate-300 font-bold uppercase tracking-widest leading-none">
                            {authLoading ? 'Conectando...' : 'Servicios de Nube Listos'}
                        </p>
                    </Card>
                </div>
            );
        };

        // --- App Principal ---

        function App() {
            const [view, setView] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [actionLoading, setActionLoading] = useState(false);
            const [syncStatus, setSyncStatus] = useState('offline'); 
            
            const [companyId, setCompanyId] = useState(localStorage.getItem('lorhels_slug') || null);
            const [companyName, setCompanyName] = useState(localStorage.getItem('lorhels_name') || '');
            const [defaultCurrency, setDefaultCurrency] = useState(localStorage.getItem('lorhels_currency') || 'DOP');
            
            const [data, setData] = useState({ invoices: [], products: [], clients: [] });
            // CAMBIO: Estado modal ahora soporta 'data' para edición
            const [modal, setModal] = useState({ open: false, type: '', data: null });
            
            // NUEVO: Estado para controlar las vistas y el buscador
            const [clientViewMode, setClientViewMode] = useState('grid');
            const [inventoryViewMode, setInventoryViewMode] = useState('grid'); // Estado para vista de inventario
            const [searchTerm, setSearchTerm] = useState('');
            const [trackStock, setTrackStock] = useState(true); // Estado para el checkbox del modal de productos

            // REGLA 3: Autenticación antes de cualquier consulta
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try { await signInWithCustomToken(auth, __initial_auth_token); } catch (e) { await signInAnonymously(auth); }
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { console.error("Auth Fail:", e); }
                };
                initAuth();

                const unsub = onAuthStateChanged(auth, u => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            // ESTRUCTURA SEGÚN TUS REGLAS: artifacts/{companyId}/users/{userId}/{collectionName}
            // MODIFICACIÓN: Ahora usamos 'public/data' para que sea compartido por EMPRESA, no por USUARIO
            useEffect(() => {
                if (!user || !companyId) return;
                
                setSyncStatus('conectando');
                // CAMBIO: Ruta pública compartida para la empresa
                const basePath = ['artifacts', companyId, 'public', 'data'];

                const handleErr = (err) => {
                    console.error("Firestore error:", err);
                    setSyncStatus('error');
                };

                const unsubInv = onSnapshot(collection(db, ...basePath, 'invoices'), s => {
                    setData(prev => ({ ...prev, invoices: s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.timestamp - a.timestamp) }));
                    setSyncStatus('online');
                }, handleErr);

                const unsubProd = onSnapshot(collection(db, ...basePath, 'products'), s => {
                    setData(prev => ({ ...prev, products: s.docs.map(d => ({id: d.id, ...d.data()})) }));
                }, handleErr);

                const unsubCli = onSnapshot(collection(db, ...basePath, 'clients'), s => {
                    setData(prev => ({ ...prev, clients: s.docs.map(d => ({id: d.id, ...d.data()})) }));
                }, handleErr);

                return () => { unsubInv(); unsubProd(); unsubCli(); };
            }, [user, companyId]);

            // Efecto para limpiar el buscador al cambiar de vista
            useEffect(() => {
                setSearchTerm('');
            }, [view]);

            // Efecto para inicializar el estado del checkbox cuando se abre el modal para editar un producto
            useEffect(() => {
                if (modal.open && modal.type === 'product' && modal.data) {
                    setTrackStock(modal.data.trackStock !== false); // Por defecto true si no existe
                } else if (modal.open && modal.type === 'product' && !modal.data) {
                    setTrackStock(true); // Nuevo producto por defecto con stock
                }
            }, [modal.open, modal.type, modal.data]);

            const handleLogin = (slug, name) => {
                setCompanyId(slug); setCompanyName(name);
                localStorage.setItem('lorhels_slug', slug); localStorage.setItem('lorhels_name', name);
            };

            const handleLogout = () => {
                setCompanyId(null); setCompanyName('');
                localStorage.removeItem('lorhels_slug'); localStorage.removeItem('lorhels_name');
            };

            const handleCurrencyChange = (curr) => {
                setDefaultCurrency(curr);
                localStorage.setItem('lorhels_currency', curr);
            };

            const saveData = async (type, payload) => {
                if (!user || !companyId) return;
                setActionLoading(true);

                try {
                    // Pre-procesamiento de datos específicos
                    if (type === 'product') {
                        payload.trackStock = payload.trackStock === 'on'; // Checkbox value
                        if(payload.purchasePrice) payload.purchasePrice = parseFloat(payload.purchasePrice) || 0;
                        if(payload.salePrice) payload.salePrice = parseFloat(payload.salePrice) || 0;
                        // Mapeo legacy para que funcione con dashboards viejos
                        payload.price = payload.salePrice; 
                        
                        if (payload.trackStock) {
                            if(payload.stock) payload.stock = parseInt(payload.stock) || 0;
                            if(payload.minStock) payload.minStock = parseInt(payload.minStock) || 0;
                        } else {
                            payload.stock = 0;
                            payload.minStock = 0;
                        }
                    }

                    // Path: artifacts/{companyId}/public/data/{collectionName}
                    const collectionName = type + 's';
                    
                    if (payload.id) {
                        // CAMBIO: Lógica de EDICIÓN (Update)
                        const docRef = doc(db, 'artifacts', companyId, 'public', 'data', collectionName, payload.id);
                        const { id, ...dataToUpdate } = payload; // Extraemos el ID para no guardarlo dentro del documento
                        await updateDoc(docRef, dataToUpdate);
                    } else {
                        // CAMBIO: Lógica de CREACIÓN (Create)
                        const colRef = collection(db, 'artifacts', companyId, 'public', 'data', collectionName);
                        await addDoc(colRef, {
                            ...payload,
                            createdBy: user.uid,
                            timestamp: Date.now(),
                            date: new Date().toISOString().split('T')[0]
                        });
                    }
                    
                    setModal({ open: false, type: '', data: null });
                } catch (err) {
                    console.error("Save error:", err);
                    alert(`Error de permisos. Asegúrate de que las reglas en Firebase permitan escribir en: artifacts/${companyId}/public/data/${type}s`);
                } finally {
                    setActionLoading(false);
                }
            };

            const deleteData = async (type, id) => {
                if (!user || !companyId) return;
                try {
                    // CAMBIO: Borrar de ruta pública compartida
                    await deleteDoc(doc(db, 'artifacts', companyId, 'public', 'data', type + 's', id));
                } catch (err) { console.error(err); }
            };

            // Helper para calcular deuda del cliente (CxC)
            const getClientDebt = (clientName) => {
                const debt = data.invoices
                    .filter(inv => inv.clientName === clientName && inv.status !== 'pagada')
                    .reduce((acc, inv) => {
                        const curr = inv.currency || 'EUR';
                        acc[curr] = (acc[curr] || 0) + (inv.total || 0);
                        return acc;
                    }, {});
                return debt;
            };

            // Filtrado de clientes
            const filteredClients = useMemo(() => {
                if (!searchTerm || view !== 'clients') return data.clients;
                const lowerTerm = searchTerm.toLowerCase();
                return data.clients.filter(c => 
                    c.name.toLowerCase().includes(lowerTerm) || 
                    c.rnc.includes(lowerTerm) ||
                    c.email.toLowerCase().includes(lowerTerm)
                );
            }, [data.clients, searchTerm, view]);

            // Filtrado de productos
            const filteredProducts = useMemo(() => {
                if (!searchTerm || view !== 'inventory') return data.products;
                const lowerTerm = searchTerm.toLowerCase();
                return data.products.filter(p => 
                    p.name.toLowerCase().includes(lowerTerm) || 
                    (p.code && p.code.toLowerCase().includes(lowerTerm)) ||
                    (p.category && p.category.toLowerCase().includes(lowerTerm))
                );
            }, [data.products, searchTerm, view]);

            // Calculate Stock Value for Dashboard (Stock * Price)
            const productsWithValue = useMemo(() => {
                return data.products.map(p => ({
                    ...p,
                    stockValue: (parseFloat(p.price) || 0) * (parseInt(p.stock) || 0)
                }));
            }, [data.products]);

            if (loading) return (
                <div className="h-screen flex flex-col items-center justify-center bg-white">
                    <div className="w-16 h-16 border-4 border-slate-100 border-t-indigo-600 rounded-full animate-spin mb-6"></div>
                    <p className="font-black italic text-indigo-950 uppercase tracking-tighter text-xl">LorHels Systems...</p>
                </div>
            );

            if (!companyId) return <LoginScreen onLogin={handleLogin} authLoading={!user} />;

            return (
                <div className="flex h-screen w-full relative bg-[#f8fafc]">
                    
                    {/* Sidebar */}
                    <aside className={`${sidebarOpen ? 'w-80' : 'w-24'} bg-white border-r border-slate-100 sidebar-transition flex flex-col z-30 shadow-2xl shadow-slate-200/40`}>
                        <div className="p-10 flex items-center gap-4 overflow-hidden">
                            <div className="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center flex-shrink-0 text-white shadow-xl shadow-indigo-100 transform -rotate-6">
                                <Icon name="TrendingUp" size={24} />
                            </div>
                            {sidebarOpen && <h1 className="font-black text-2xl tracking-tighter italic uppercase text-indigo-950">LorHels</h1>}
                        </div>

                        <nav className="flex-grow px-6 space-y-2">
                            {[
                                { id: 'dashboard', label: 'Dashboard', icon: 'LayoutDashboard' },
                                { id: 'invoices', label: 'Facturación', icon: 'FileText' },
                                { id: 'inventory', label: 'Inventario', icon: 'Package' },
                                { id: 'clients', label: 'Clientes', icon: 'Users' },
                                { id: 'settings', label: 'Configuración', icon: 'Settings' }
                            ].map(item => (
                                <button key={item.id} onClick={() => setView(item.id)} className={`w-full flex items-center gap-4 px-5 py-4 rounded-2xl transition-all group ${view === item.id ? 'bg-indigo-600 text-white shadow-2xl shadow-indigo-200' : 'text-slate-400 hover:bg-indigo-50 hover:text-indigo-600'}`}>
                                    <Icon name={item.icon} size={22} className={view === item.id ? 'scale-110' : 'group-hover:scale-110'} />
                                    {sidebarOpen && <span className="font-bold text-sm tracking-tight">{item.label}</span>}
                                </button>
                            ))}
                        </nav>

                        <div className="p-8 space-y-4">
                            <button onClick={handleLogout} className="w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-red-400 hover:bg-red-50 transition-all font-bold text-sm">
                                <Icon name="LogOut" size={20} /> {sidebarOpen && "Salir Empresa"}
                            </button>
                            <button onClick={() => setSidebarOpen(!sidebarOpen)} className="w-full flex items-center justify-center p-4 bg-slate-50 rounded-2xl text-slate-400 hover:text-indigo-600 transition-all">
                                <Icon name="ChevronRight" size={24} className={sidebarOpen ? 'rotate-180' : ''} />
                            </button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-grow flex flex-col overflow-hidden">
                        <header className="h-28 glass border-b border-slate-100 flex items-center justify-between px-12 sticky top-0 z-20">
                            <div>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 leading-none">Cloud Infrastructure Node</p>
                                <div className="flex items-center gap-2 mt-1">
                                    <div className={`w-2.5 h-2.5 rounded-full animate-pulse shadow-[0_0_10px_rgba(79,70,229,0.5)] ${syncStatus === 'online' ? 'bg-emerald-500' : syncStatus === 'error' ? 'bg-red-500' : 'bg-amber-500'}`}></div>
                                    <p className="text-2xl font-black text-slate-800 uppercase italic leading-none">{companyName}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-6">
                                <div className="text-right hidden sm:block">
                                    <p className="text-[10px] font-black uppercase text-indigo-600 tracking-widest leading-none mb-1">Sesión Segura</p>
                                    <p className="text-xs font-bold text-slate-400 font-mono truncate w-32">{user?.uid.slice(0,12)}...</p>
                                </div>
                                <div className="w-14 h-14 rounded-2xl bg-indigo-50 border-2 border-white shadow-xl overflow-hidden cursor-pointer hover:scale-105 transition-transform">
                                    <img src={`https://api.dicebear.com/7.x/shapes/svg?seed=${user?.uid}`} alt="Avatar" />
                                </div>
                            </div>
                        </header>

                        <div className="flex-grow overflow-y-auto p-12 custom-shadow">
                            <div className="max-w-7xl mx-auto pb-20">
                                
                                {view === 'dashboard' && (
                                    <div className="space-y-8 animate-slide-up">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                                            <Card className="p-8 border-l-8 border-indigo-600 transform hover:-translate-y-1 transition-all">
                                                <p className="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-2">Ingresos Consolidados</p>
                                                <MultiCurrencyTotal data={data.invoices} valueField="total" defaultColor="text-indigo-950" />
                                            </Card>
                                            <Card className="p-8 border-l-8 border-emerald-600 transform hover:-translate-y-1 transition-all">
                                                <p className="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-2">Clientes en Mi Perfil</p>
                                                <h3 className="text-4xl font-black text-emerald-950">{data.clients.length}</h3>
                                            </Card>
                                            <Card className="p-8 border-l-8 border-amber-600 transform hover:-translate-y-1 transition-all">
                                                <p className="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-2">Valor de Stock</p>
                                                <MultiCurrencyTotal data={productsWithValue} valueField="stockValue" defaultColor="text-amber-950" />
                                            </Card>
                                        </div>

                                        <Card className="p-10">
                                            <div className="flex justify-between items-center mb-10 text-indigo-950">
                                                <h3 className="text-2xl font-black italic uppercase">Mi Actividad Reciente</h3>
                                                <Badge variant={syncStatus === 'online' ? 'success' : 'warning'}>
                                                    {syncStatus === 'online' ? 'Sincronizado' : 'Conectando Firestore...'}
                                                </Badge>
                                            </div>
                                            <div className="space-y-6">
                                                {data.invoices.slice(0, 5).map(inv => (
                                                    <div key={inv.id} className="flex items-center justify-between p-5 bg-slate-50 rounded-3xl border border-transparent hover:border-indigo-100 hover:bg-white transition-all group">
                                                        <div className="flex items-center gap-5">
                                                            <div className="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-indigo-600 shadow-sm border border-slate-100 group-hover:bg-indigo-600 group-hover:text-white transition-all"><Icon name="FileText" /></div>
                                                            <div>
                                                                <p className="font-black text-slate-800 uppercase tracking-tight">{inv.clientName}</p>
                                                                <div className="flex items-center gap-2 text-[10px] text-slate-400 font-bold uppercase">
                                                                    <span>{inv.date}</span>
                                                                    <span className="w-1 h-1 bg-slate-300 rounded-full"></span>
                                                                    <span className="text-indigo-400">{inv.currency || 'EUR'}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="text-right flex items-center gap-6">
                                                            <p className="font-black text-xl text-indigo-600 tracking-tighter">
                                                                {formatCurrency(inv.total, inv.currency || 'EUR')}
                                                            </p>
                                                            <button onClick={() => deleteData('invoice', inv.id)} className="p-2 text-slate-200 hover:text-red-500 transition-colors"><Icon name="Trash2" size={18} /></button>
                                                        </div>
                                                    </div>
                                                ))}
                                                {data.invoices.length === 0 && <div className="text-center py-20 opacity-30 italic font-medium">No hay registros almacenados en tu perfil de {companyName}.</div>}
                                            </div>
                                        </Card>
                                    </div>
                                )}

                                {view === 'clients' && (
                                    <div className="space-y-8 animate-slide-up">
                                        <div className="flex flex-col md:flex-row justify-between items-end md:items-center gap-4">
                                            <div>
                                                <h2 className="text-4xl font-black italic text-indigo-950">Mis Clientes</h2>
                                                <p className="text-slate-500 font-medium mt-1 uppercase text-[10px] tracking-widest">Base de datos de usuario en {companyName}</p>
                                            </div>
                                            
                                            <div className="flex flex-col sm:flex-row items-center gap-3 w-full md:w-auto">
                                                {/* Buscador */}
                                                <div className="relative w-full sm:w-64">
                                                    <Icon name="Search" size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                                    <input 
                                                        type="text" 
                                                        placeholder="Buscar cliente..." 
                                                        value={searchTerm}
                                                        onChange={(e) => setSearchTerm(e.target.value)}
                                                        className="w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-bold focus:outline-none focus:border-indigo-500 transition-all shadow-sm"
                                                    />
                                                </div>

                                                <div className="flex items-center gap-3">
                                                    {/* Selector de Vistas */}
                                                    <div className="bg-white p-1 rounded-xl border border-slate-100 flex shadow-sm">
                                                        <button 
                                                            onClick={() => setClientViewMode('grid')} 
                                                            className={`p-2 rounded-lg transition-all ${clientViewMode === 'grid' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-300 hover:text-slate-500'}`}
                                                            title="Vista Cuadrícula"
                                                        >
                                                            <Icon name="LayoutGrid" size={20} />
                                                        </button>
                                                        <button 
                                                            onClick={() => setClientViewMode('list')} 
                                                            className={`p-2 rounded-lg transition-all ${clientViewMode === 'list' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-300 hover:text-slate-500'}`}
                                                            title="Vista Lista"
                                                        >
                                                            <Icon name="List" size={20} />
                                                        </button>
                                                    </div>

                                                    <Button icon="Plus" onClick={() => setModal({ open: true, type: 'client', data: null })}>Nuevo</Button>
                                                </div>
                                            </div>
                                        </div>

                                        {/* VISTA CUADRÍCULA */}
                                        {clientViewMode === 'grid' && (
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                                {filteredClients.map(c => {
                                                    const debt = getClientDebt(c.name);
                                                    const hasDebt = Object.keys(debt).length > 0;
                                                    
                                                    return (
                                                        <Card key={c.id} className="p-8 group hover:border-indigo-200 transition-all transform hover:-translate-y-1 relative">
                                                            <div className="flex justify-between items-start mb-6">
                                                                <div className="w-16 h-16 bg-slate-100 rounded-[1.5rem] flex items-center justify-center font-black text-3xl text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition-all transform -rotate-6">
                                                                    {c.name?.charAt(0)}
                                                                </div>
                                                                <div className="flex gap-2">
                                                                    <button onClick={() => setModal({ open: true, type: 'client', data: c })} className="p-2 text-slate-200 hover:text-indigo-500 transition-colors"><Icon name="Pencil" size={18} /></button>
                                                                    <button onClick={() => deleteData('client', c.id)} className="p-2 text-slate-200 hover:text-red-500 transition-colors"><Icon name="Trash2" /></button>
                                                                </div>
                                                            </div>
                                                            <div className="mb-2">
                                                                <h4 className="font-black text-xl text-indigo-950 mb-1 leading-tight">{c.name}</h4>
                                                                <span className={`inline-block px-2 py-1 rounded-md text-[10px] font-black uppercase tracking-wider mb-2 ${CLIENT_TYPES[c.type]?.color || 'bg-slate-100 text-slate-400'}`}>
                                                                    {CLIENT_TYPES[c.type]?.label || 'Sin Clasificar'}
                                                                </span>
                                                            </div>
                                                            <p className="text-xs font-black text-indigo-600 mb-6 bg-indigo-50 inline-block px-3 py-1 rounded-lg tracking-tighter">
                                                                {DOC_TYPES[c.docType || 'rnc']}: {c.rnc}
                                                            </p>
                                                            
                                                            <div className="space-y-3 mb-6 text-[11px] text-slate-500 font-bold tracking-tight">
                                                                <div className="flex items-center gap-3"><Icon name="Mail" size={14} className="text-indigo-300"/> <span className="truncate">{c.email}</span></div>
                                                                <div className="flex items-center gap-3"><Icon name="Phone" size={14} className="text-indigo-300"/> <span>{c.phone}</span></div>
                                                            </div>

                                                            {/* Sección de Deuda y Crédito */}
                                                            <div className="pt-4 border-t border-slate-50 grid grid-cols-2 gap-4">
                                                                <div>
                                                                    <p className="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-1 leading-none">Límite Crédito</p>
                                                                    <p className="text-sm font-black text-emerald-600 tracking-tighter leading-none">{formatCurrency(c.creditLimit, c.currency || 'DOP')}</p>
                                                                </div>
                                                                <div className="text-right">
                                                                    <p className="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-1 leading-none">Valor por Pagar</p>
                                                                    {hasDebt ? (
                                                                        Object.entries(debt).map(([curr, val]) => (
                                                                            <p key={curr} className="text-sm font-black text-red-500 tracking-tighter leading-none">
                                                                                {formatCurrency(val, curr)}
                                                                            </p>
                                                                        ))
                                                                    ) : (
                                                                        <p className="text-sm font-bold text-slate-300">Sin Deuda</p>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </Card>
                                                    );
                                                })}
                                            </div>
                                        )}

                                        {/* VISTA LISTA (TABLA) */}
                                        {clientViewMode === 'list' && (
                                            <div className="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-left border-collapse">
                                                        <thead>
                                                            <tr className="bg-slate-50 border-b border-slate-100 text-[10px] uppercase text-slate-400 font-black tracking-widest">
                                                                <th className="p-6">Empresa / Tipo</th>
                                                                <th className="p-6">Identificación</th>
                                                                <th className="p-6">Contacto</th>
                                                                <th className="p-6 text-right">Crédito</th>
                                                                <th className="p-6 text-right">Balance Pendiente</th>
                                                                <th className="p-6 text-center">Acciones</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="text-sm">
                                                            {filteredClients.map(c => {
                                                                const debt = getClientDebt(c.name);
                                                                const hasDebt = Object.keys(debt).length > 0;

                                                                return (
                                                                    <tr key={c.id} className="border-b border-slate-50 hover:bg-indigo-50/30 transition-colors group">
                                                                        <td className="p-6">
                                                                            <div className="flex items-center gap-4">
                                                                                <div className="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center font-black text-lg shadow-sm">
                                                                                    {c.name?.charAt(0)}
                                                                                </div>
                                                                                <div>
                                                                                    <h4 className="font-bold text-indigo-950 text-base">{c.name}</h4>
                                                                                    <span className={`inline-block px-1.5 py-0.5 rounded text-[9px] font-black uppercase tracking-wider ${CLIENT_TYPES[c.type]?.color || 'bg-slate-100 text-slate-400'}`}>
                                                                                        {CLIENT_TYPES[c.type]?.label || 'Sin Clasificar'}
                                                                                    </span>
                                                                                </div>
                                                                            </div>
                                                                        </td>
                                                                        <td className="p-6">
                                                                            <div className="flex flex-col">
                                                                                <span className="font-mono text-slate-600 font-bold">{c.rnc}</span>
                                                                                <span className="text-[10px] text-slate-400 font-medium">{DOC_TYPES[c.docType || 'rnc']}</span>
                                                                            </div>
                                                                        </td>
                                                                        <td className="p-6">
                                                                            <div className="flex flex-col gap-1 text-slate-500 font-medium text-xs">
                                                                                <div className="flex items-center gap-2"><Icon name="Mail" size={12} className="text-indigo-300"/> {c.email}</div>
                                                                                <div className="flex items-center gap-2"><Icon name="Phone" size={12} className="text-indigo-300"/> {c.phone}</div>
                                                                            </div>
                                                                        </td>
                                                                        <td className="p-6 text-right">
                                                                            <span className="font-black text-emerald-600 bg-emerald-50 px-3 py-1 rounded-lg">
                                                                                {formatCurrency(c.creditLimit, c.currency || 'DOP')}
                                                                            </span>
                                                                        </td>
                                                                        <td className="p-6 text-right">
                                                                            {hasDebt ? (
                                                                                Object.entries(debt).map(([curr, val]) => (
                                                                                    <div key={curr} className="font-black text-red-500 text-sm">
                                                                                        {formatCurrency(val, curr)}
                                                                                    </div>
                                                                                ))
                                                                            ) : (
                                                                                <span className="text-xs font-bold text-slate-300">-</span>
                                                                            )}
                                                                        </td>
                                                                        <td className="p-6">
                                                                            <div className="flex justify-center gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
                                                                                <button onClick={() => setModal({ open: true, type: 'client', data: c })} className="p-2 bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-indigo-600 hover:border-indigo-200 transition-all shadow-sm"><Icon name="Pencil" size={16} /></button>
                                                                                <button onClick={() => deleteData('client', c.id)} className="p-2 bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-red-500 hover:border-red-200 transition-all shadow-sm"><Icon name="Trash2" size={16} /></button>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                {filteredClients.length === 0 && (
                                                    <div className="p-12 text-center opacity-40">
                                                        <Icon name="SearchX" size={48} className="mx-auto mb-4 text-slate-300" />
                                                        <p className="font-bold text-slate-500">No se encontraron clientes.</p>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {view === 'settings' && (
                                    <div className="max-w-2xl animate-slide-up space-y-8">
                                        <h2 className="text-4xl font-black italic text-indigo-950">Ajustes</h2>
                                        <Card className="p-10">
                                            <div className="flex items-center gap-4 mb-8">
                                                <div className="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center"><Icon name="Shield" /></div>
                                                <div>
                                                    <h4 className="font-black text-xl text-indigo-950">Seguridad de Perfil</h4>
                                                    <p className="text-sm text-slate-400 font-bold">Protocolos activos para {companyName}</p>
                                                </div>
                                            </div>
                                            <div className="p-6 bg-slate-50 rounded-2xl space-y-3 border-2 border-slate-100 font-bold mb-8">
                                                <div className="flex justify-between items-center"><span className="text-xs text-slate-400 uppercase tracking-widest">ID Empresa:</span><span className="text-indigo-600 font-mono">{companyId}</span></div>
                                                <div className="flex justify-between items-center"><span className="text-xs text-slate-400 uppercase tracking-widest">UID Usuario:</span><span className="text-slate-600 font-mono text-[10px]">{user?.uid}</span></div>
                                                <div className="flex justify-between items-center"><span className="text-xs text-slate-400 uppercase tracking-widest">Entorno:</span><span className="text-indigo-600 uppercase bg-indigo-50 px-2 py-1 rounded-lg text-[10px]">Global (Empresarial)</span></div>
                                            </div>

                                            <div className="flex items-center gap-4 mb-4">
                                                <div className="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center"><Icon name="Coins" /></div>
                                                <div>
                                                    <h4 className="font-black text-xl text-indigo-950">Preferencia de Moneda</h4>
                                                    <p className="text-sm text-slate-400 font-bold">Moneda por defecto para nuevos registros</p>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-3 gap-4">
                                                {Object.entries(CURRENCIES).map(([code, details]) => (
                                                    <button 
                                                        key={code}
                                                        onClick={() => handleCurrencyChange(code)}
                                                        className={`p-4 rounded-xl font-bold border-2 transition-all ${defaultCurrency === code ? 'border-emerald-500 bg-emerald-50 text-emerald-700' : 'border-slate-100 bg-white text-slate-400 hover:border-slate-200'}`}
                                                    >
                                                        <div className="text-2xl mb-1">{details.symbol}</div>
                                                        <div className="text-xs uppercase tracking-wider">{code}</div>
                                                    </button>
                                                ))}
                                            </div>
                                        </Card>
                                    </div>
                                )}

                                {view === 'invoices' && (
                                    <div className="space-y-8 animate-slide-up">
                                        <div className="flex justify-between items-end">
                                            <div>
                                                <h2 className="text-4xl font-black italic text-indigo-950 capitalize">Facturación</h2>
                                                <p className="text-slate-500 font-medium mt-1 uppercase text-xs tracking-widest">Gestión privada para {companyName}</p>
                                            </div>
                                            <Button icon="Plus" onClick={() => setModal({ open: true, type: 'invoice', data: null })}>
                                                Añadir Registro
                                            </Button>
                                        </div>
                                        
                                        {/* Vista de Listado para Facturas */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            {data.invoices.map(inv => (
                                                <Card key={inv.id} className="p-6 relative overflow-hidden group hover:-translate-y-1 transition-transform">
                                                    <div className="absolute top-0 right-0 p-4 opacity-10 font-black text-6xl rotate-12 group-hover:scale-110 transition-transform select-none">
                                                        {CURRENCIES[inv.currency || 'EUR']?.symbol}
                                                    </div>
                                                    <div className="relative z-10">
                                                        <div className="flex justify-between items-start mb-4">
                                                            <div className="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center"><Icon name="FileText" size={18} /></div>
                                                            <Badge variant={inv.status === 'pagada' ? 'success' : 'default'}>{inv.status || 'Pendiente'}</Badge>
                                                        </div>
                                                        <h4 className="font-bold text-lg text-slate-800 mb-1">{inv.clientName}</h4>
                                                        <p className="text-xs text-slate-400 font-bold mb-4">{inv.date}</p>
                                                        <div className="pt-4 border-t border-slate-50 flex justify-between items-end">
                                                            <div className="flex flex-col">
                                                                <span className="text-[10px] uppercase font-black text-slate-300 tracking-widest">Total</span>
                                                                <span className="text-2xl font-black text-indigo-600">{formatCurrency(inv.total, inv.currency || 'EUR')}</span>
                                                            </div>
                                                            <button onClick={() => deleteData('invoice', inv.id)} className="text-slate-300 hover:text-red-500 transition-colors"><Icon name="Trash2" size={18} /></button>
                                                        </div>
                                                    </div>
                                                </Card>
                                            ))}
                                        </div>

                                        {data.invoices.length === 0 && (
                                            <Card className="py-40 text-center opacity-20 border-dashed border-4 border-indigo-200">
                                                <Icon name="FileText" size={100} className="mx-auto mb-6 text-indigo-300" />
                                                <p className="text-3xl font-black italic uppercase tracking-tighter">Base de Datos Vacía</p>
                                                <p className="text-sm font-bold opacity-60">Los datos que añadas serán visibles para toda la organización.</p>
                                            </Card>
                                        )}
                                    </div>
                                )}

                                {view === 'inventory' && (
                                    <div className="space-y-8 animate-slide-up">
                                        <div className="flex flex-col md:flex-row justify-between items-end md:items-center gap-4">
                                            <div>
                                                <h2 className="text-4xl font-black italic text-indigo-950">Inventario</h2>
                                                <p className="text-slate-500 font-medium mt-1 uppercase text-[10px] tracking-widest">Control de Stock y Productos</p>
                                            </div>
                                            
                                            <div className="flex flex-col sm:flex-row items-center gap-3 w-full md:w-auto">
                                                {/* Buscador de Productos */}
                                                <div className="relative w-full sm:w-64">
                                                    <Icon name="Search" size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                                    <input 
                                                        type="text" 
                                                        placeholder="Buscar producto..." 
                                                        value={searchTerm}
                                                        onChange={(e) => setSearchTerm(e.target.value)}
                                                        className="w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-bold focus:outline-none focus:border-indigo-500 transition-all shadow-sm"
                                                    />
                                                </div>

                                                <div className="flex items-center gap-3">
                                                    {/* Selector de Vistas de Inventario */}
                                                    <div className="bg-white p-1 rounded-xl border border-slate-100 flex shadow-sm">
                                                        <button 
                                                            onClick={() => setInventoryViewMode('grid')} 
                                                            className={`p-2 rounded-lg transition-all ${inventoryViewMode === 'grid' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-300 hover:text-slate-500'}`}
                                                            title="Vista Cuadrícula"
                                                        >
                                                            <Icon name="LayoutGrid" size={20} />
                                                        </button>
                                                        <button 
                                                            onClick={() => setInventoryViewMode('list')} 
                                                            className={`p-2 rounded-lg transition-all ${inventoryViewMode === 'list' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-300 hover:text-slate-500'}`}
                                                            title="Vista Lista"
                                                        >
                                                            <Icon name="List" size={20} />
                                                        </button>
                                                    </div>

                                                    <Button icon="Plus" onClick={() => setModal({ open: true, type: 'product', data: null })}>Nuevo</Button>
                                                </div>
                                            </div>
                                        </div>

                                        {/* INVENTARIO: VISTA CUADRÍCULA */}
                                        {inventoryViewMode === 'grid' && (
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                                {filteredProducts.map(prod => {
                                                    const isLowStock = prod.trackStock && (prod.stock <= (prod.minStock || 5));
                                                    return (
                                                        <Card key={prod.id} className={`p-6 relative overflow-hidden group hover:-translate-y-1 transition-transform ${isLowStock ? 'border-2 border-red-100 bg-red-50/20' : ''}`}>
                                                            <div className="relative z-10">
                                                                <div className="flex justify-between items-start mb-4">
                                                                    <div className="flex gap-3">
                                                                        <div className="w-10 h-10 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center"><Icon name="Package" size={18} /></div>
                                                                        <div>
                                                                            <p className="text-[10px] uppercase font-black text-slate-400 tracking-wider">#{prod.code || 'S/N'}</p>
                                                                            <p className="text-[10px] uppercase font-black text-indigo-400 tracking-wider">{prod.category || 'General'}</p>
                                                                        </div>
                                                                    </div>
                                                                    {prod.trackStock ? (
                                                                        <div className={`px-2 py-1 rounded-lg text-xs font-black ${isLowStock ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-slate-100 text-slate-600'}`}>
                                                                            x{prod.stock} {prod.unit || ''}
                                                                        </div>
                                                                    ) : (
                                                                        <div className="px-2 py-1 rounded-lg text-[10px] font-bold bg-slate-50 text-slate-400 uppercase">Infinito</div>
                                                                    )}
                                                                </div>
                                                                
                                                                <h4 className="font-bold text-lg text-slate-800 mb-1 leading-tight">{prod.name}</h4>
                                                                
                                                                <div className="pt-4 border-t border-slate-50 flex justify-between items-end mt-4">
                                                                    <div className="flex flex-col">
                                                                        <span className="text-[10px] uppercase font-black text-slate-300 tracking-widest">Precio Venta</span>
                                                                        <span className="text-xl font-black text-amber-600">{formatCurrency(prod.salePrice, prod.currency || 'EUR')}</span>
                                                                    </div>
                                                                    <div className="flex gap-2">
                                                                        <button onClick={() => setModal({ open: true, type: 'product', data: prod })} className="text-slate-300 hover:text-indigo-500 transition-colors"><Icon name="Pencil" size={18} /></button>
                                                                        <button onClick={() => deleteData('product', prod.id)} className="text-slate-300 hover:text-red-500 transition-colors"><Icon name="Trash2" size={18} /></button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </Card>
                                                    );
                                                })}
                                            </div>
                                        )}

                                        {/* INVENTARIO: VISTA LISTA (TABLA) */}
                                        {inventoryViewMode === 'list' && (
                                            <div className="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-left border-collapse">
                                                        <thead>
                                                            <tr className="bg-slate-50 border-b border-slate-100 text-[10px] uppercase text-slate-400 font-black tracking-widest">
                                                                <th className="p-6">Producto</th>
                                                                <th className="p-6">Categoría</th>
                                                                <th className="p-6 text-center">Existencia</th>
                                                                <th className="p-6 text-right">Costo</th>
                                                                <th className="p-6 text-right">Precio</th>
                                                                <th className="p-6 text-center">Acciones</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="text-sm">
                                                            {filteredProducts.map(prod => {
                                                                const isLowStock = prod.trackStock && (prod.stock <= (prod.minStock || 5));
                                                                return (
                                                                    <tr key={prod.id} className="border-b border-slate-50 hover:bg-amber-50/30 transition-colors group">
                                                                        <td className="p-6">
                                                                            <div className="flex items-center gap-4">
                                                                                <div className="w-10 h-10 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center"><Icon name="Package" size={18} /></div>
                                                                                <div>
                                                                                    <h4 className="font-bold text-slate-800 text-base">{prod.name}</h4>
                                                                                    <span className="text-[10px] font-mono text-slate-400 font-bold uppercase tracking-wider">#{prod.code || 'S/N'}</span>
                                                                                </div>
                                                                            </div>
                                                                        </td>
                                                                        <td className="p-6">
                                                                            <span className="bg-slate-100 text-slate-600 px-2 py-1 rounded-md text-xs font-bold uppercase tracking-wide">
                                                                                {prod.category || 'General'}
                                                                            </span>
                                                                        </td>
                                                                        <td className="p-6 text-center">
                                                                            {prod.trackStock ? (
                                                                                <div className={`inline-flex flex-col items-center ${isLowStock ? 'text-red-500' : 'text-slate-600'}`}>
                                                                                    <span className="font-black text-lg leading-none">{prod.stock}</span>
                                                                                    <span className="text-[9px] uppercase font-bold">{prod.unit || 'UND'}</span>
                                                                                </div>
                                                                            ) : (
                                                                                <Icon name="Infinity" size={18} className="text-slate-300 mx-auto" />
                                                                            )}
                                                                        </td>
                                                                        <td className="p-6 text-right font-medium text-slate-400">
                                                                            {formatCurrency(prod.purchasePrice, prod.currency || 'EUR')}
                                                                        </td>
                                                                        <td className="p-6 text-right">
                                                                            <span className="font-black text-amber-600 text-lg">
                                                                                {formatCurrency(prod.salePrice, prod.currency || 'EUR')}
                                                                            </span>
                                                                        </td>
                                                                        <td className="p-6">
                                                                            <div className="flex justify-center gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
                                                                                <button onClick={() => setModal({ open: true, type: 'product', data: prod })} className="p-2 bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-indigo-600 hover:border-indigo-200 transition-all shadow-sm"><Icon name="Pencil" size={16} /></button>
                                                                                <button onClick={() => deleteData('product', prod.id)} className="p-2 bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-red-500 hover:border-red-200 transition-all shadow-sm"><Icon name="Trash2" size={16} /></button>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        )}

                                        {filteredProducts.length === 0 && (
                                            <div className="p-12 text-center opacity-40">
                                                <Icon name="SearchX" size={48} className="mx-auto mb-4 text-slate-300" />
                                                <p className="font-bold text-slate-500">No se encontraron productos.</p>
                                            </div>
                                        )}
                                        
                                        {/* Mensaje vacío original solo si no hay datos en absoluto (sin búsqueda) */}
                                        {data.products.length === 0 && !searchTerm && (
                                            <Card className="py-40 text-center opacity-20 border-dashed border-4 border-indigo-200">
                                                <Icon name="Package" size={100} className="mx-auto mb-6 text-indigo-300" />
                                                <p className="text-3xl font-black italic uppercase tracking-tighter">Inventario Vacío</p>
                                                <p className="text-sm font-bold opacity-60">Añade tu primer producto para comenzar.</p>
                                            </Card>
                                        )}
                                    </div>
                                )}

                            </div>
                        </div>
                    </main>

                    {/* Modales */}
                    <Modal 
                        isOpen={modal.open} 
                        onClose={() => setModal({ open: false, type: '', data: null })} 
                        title={modal.data ? `Editar ${modal.type === 'client' ? 'Cliente' : 'Registro'}` : `Nuevo Registro`}
                    >
                        <form className="space-y-6" onSubmit={(e) => {
                            e.preventDefault();
                            const fd = new FormData(e.target);
                            const payload = Object.fromEntries(fd.entries());
                            
                            if(payload.total) payload.total = parseFloat(payload.total) || 0;
                            if(payload.price) payload.price = parseFloat(payload.price) || 0;
                            if(payload.stock) payload.stock = parseInt(payload.stock) || 0;
                            if(payload.creditLimit) payload.creditLimit = parseFloat(payload.creditLimit) || 0;
                            
                            saveData(modal.type, payload);
                        }}>
                            {/* CAMBIO: Input oculto para el ID si estamos editando */}
                            {modal.data && <input type="hidden" name="id" value={modal.data.id} />}

                            {modal.type === 'client' && (
                                <div className="space-y-4">
                                    <input name="name" defaultValue={modal.data?.name} className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Nombre de la empresa" required />
                                    
                                    {/* Selector de Tipo de Cliente */}
                                    <select name="type" defaultValue={modal.data?.type} className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner text-slate-700" required>
                                        <option value="">Selecciona Tipo de Cliente...</option>
                                        {Object.entries(CLIENT_TYPES).map(([key, val]) => (
                                            <option key={key} value={key}>{val.label}</option>
                                        ))}
                                    </select>

                                    {/* Selector de Documento y Número */}
                                    <div className="flex gap-4">
                                        <select 
                                            name="docType" 
                                            defaultValue={modal.data?.docType || 'rnc'} 
                                            className="w-1/3 p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner text-slate-700"
                                            onChange={(e) => {
                                                const input = e.target.form.elements['rnc'];
                                                if(e.target.value === 'na') {
                                                    input.value = 'N/A';
                                                    input.readOnly = true;
                                                } else {
                                                    if(input.value === 'N/A') input.value = '';
                                                    input.readOnly = false;
                                                }
                                            }}
                                        >
                                            {Object.entries(DOC_TYPES).map(([key, label]) => (
                                                <option key={key} value={key}>{label}</option>
                                            ))}
                                        </select>
                                        <input 
                                            name="rnc" 
                                            defaultValue={modal.data?.rnc} 
                                            className="w-2/3 p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" 
                                            placeholder="Número de Identificación" 
                                            required 
                                        />
                                    </div>

                                    <div className="grid grid-cols-1 gap-4">
                                        <input name="phone" defaultValue={modal.data?.phone} className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Contacto" required />
                                    </div>
                                    <input name="email" type="email" defaultValue={modal.data?.email} className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Email" required />
                                    <input name="address" defaultValue={modal.data?.address} className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Dirección" required />
                                    
                                    {/* Nuevo Selector de Moneda para el Crédito */}
                                    <div className="flex gap-4">
                                        <select name="currency" defaultValue={modal.data?.currency || defaultCurrency} className="w-1/3 p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner text-center">
                                            {Object.entries(CURRENCIES).map(([code, details]) => (
                                                <option key={code} value={code}>{code}</option>
                                            ))}
                                        </select>
                                        <input name="creditLimit" type="number" step="0.01" defaultValue={modal.data?.creditLimit} className="w-2/3 p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Límite Crédito" required />
                                    </div>
                                </div>
                            )}

                            {modal.type === 'invoice' && (
                                <div className="space-y-4">
                                    <select name="clientName" className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" required>
                                        <option value="">Selecciona Cliente...</option>
                                        {data.clients.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                                        {data.clients.length === 0 && <option value="Cliente Genérico">Cliente Genérico</option>}
                                    </select>
                                    <div className="grid grid-cols-3 gap-4">
                                        <select name="currency" defaultValue={defaultCurrency} className="col-span-1 p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner">
                                            {Object.entries(CURRENCIES).map(([code, details]) => (
                                                <option key={code} value={code}>{code}</option>
                                            ))}
                                        </select>
                                        <input name="total" type="number" step="0.01" className="col-span-2 w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Monto Total" required />
                                    </div>
                                    <input type="hidden" name="status" value="pendiente" />
                                </div>
                            )}

                            {modal.type === 'product' && (
                                <div className="space-y-4">
                                    <div className="grid grid-cols-3 gap-4">
                                        <input name="code" defaultValue={modal.data?.code} className="col-span-1 w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner uppercase font-mono" placeholder="CÓDIGO" required />
                                        <input name="name" defaultValue={modal.data?.name} className="col-span-2 w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Nombre del Producto" required />
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <input name="category" defaultValue={modal.data?.category} className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Categoría (ej. Bebidas)" />
                                        <input name="unit" defaultValue={modal.data?.unit} className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner" placeholder="Unidad (ej. UND, LB)" required />
                                    </div>

                                    <textarea name="description" defaultValue={modal.data?.description} className="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold focus:bg-white transition-all shadow-inner h-24 resize-none" placeholder="Descripción detallada del producto..."></textarea>

                                    <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                        <p className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-3">Precios y Moneda</p>
                                        <div className="flex gap-4 items-center">
                                            <select name="currency" defaultValue={modal.data?.currency || defaultCurrency} className="w-1/4 p-3 bg-white rounded-xl font-bold shadow-sm">
                                                {Object.entries(CURRENCIES).map(([code, details]) => (
                                                    <option key={code} value={code}>{code}</option>
                                                ))}
                                            </select>
                                            <div className="flex-grow grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="text-[10px] uppercase font-bold text-slate-400">Compra</label>
                                                    <input name="purchasePrice" type="number" step="0.01" defaultValue={modal.data?.purchasePrice} className="w-full p-3 bg-white rounded-xl font-bold shadow-sm" placeholder="0.00" required />
                                                </div>
                                                <div>
                                                    <label className="text-[10px] uppercase font-bold text-slate-400">Venta</label>
                                                    <input name="salePrice" type="number" step="0.01" defaultValue={modal.data?.salePrice} className="w-full p-3 bg-white rounded-xl font-bold shadow-sm text-indigo-600" placeholder="0.00" required />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                        <div className="flex justify-between items-center mb-4">
                                            <p className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Control de Inventario</p>
                                            <label className="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" name="trackStock" className="sr-only peer" checked={trackStock} onChange={(e) => setTrackStock(e.target.checked)} />
                                                <div className="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                                            </label>
                                        </div>
                                        
                                        {trackStock && (
                                            <div className="grid grid-cols-2 gap-4 animate-slide-up">
                                                <div>
                                                    <label className="text-[10px] uppercase font-bold text-slate-400">Stock Actual</label>
                                                    <input name="stock" type="number" defaultValue={modal.data?.stock} className="w-full p-3 bg-white rounded-xl font-bold shadow-sm" placeholder="0" />
                                                </div>
                                                <div>
                                                    <label className="text-[10px] uppercase font-bold text-slate-400">Stock Mínimo</label>
                                                    <input name="minStock" type="number" defaultValue={modal.data?.minStock} className="w-full p-3 bg-white rounded-xl font-bold shadow-sm text-amber-600" placeholder="5" />
                                                </div>
                                            </div>
                                        )}
                                        {!trackStock && <p className="text-xs text-slate-400 italic text-center py-2">Este producto es un servicio o no requiere inventario.</p>}
                                    </div>
                                </div>
                            )}

                            <div className="flex gap-4 pt-6 border-t border-slate-100">
                                <Button variant="ghost" className="flex-grow font-black uppercase italic" onClick={() => setModal({ open: false, type: '', data: null })}>Cancelar</Button>
                                <Button className="flex-grow font-black uppercase italic" type="submit" loading={actionLoading}>{modal.data ? 'Guardar Cambios' : 'Confirmar'}</Button>
                            </div>
                        </form>
                    </Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LorHels Systems - ERP Enterprise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Librerías para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
        .sidebar-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .custom-shadow { box-shadow: 0 10px 40px -10px rgba(79, 70, 229, 0.1); }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase Integration ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, setDoc, getDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkQ95muJR8bNBHSjRXxEGNbiknTj4wKpo",
            authDomain: "lorhels-systems-a1ad4.firebaseapp.com",
            projectId: "lorhels-systems-a1ad4",
            storageBucket: "lorhels-systems-a1ad4.firebasestorage.app",
            messagingSenderId: "387342109322",
            appId: "1:387342109322:web:be3973a4f95e82881afb73",
            measurementId: "G-MPVX6KW40J"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const currentAppId = "lorhels-systems-a1ad4";

        // --- Constants ---
        const CURRENCIES = {
            'DOP': { symbol: 'RD$', label: 'Peso Dom. (DOP)' },
            'USD': { symbol: 'US$', label: 'Dólar (USD)' }
        };

        const CLIENT_TYPES = {
            'fiscal': { label: 'Valor Fiscal', color: 'bg-indigo-50 text-indigo-700 border border-indigo-100' },
            'final': { label: 'Consumidor Final', color: 'bg-slate-50 text-slate-600 border border-slate-100' },
            'government': { label: 'Gubernamental', color: 'bg-amber-50 text-amber-700 border border-amber-100' },
            'special': { label: 'Régimen Tributario', color: 'bg-purple-50 text-purple-700 border border-purple-100' }
        };

        const DOC_TYPES = { 'rnc': 'RNC', 'cedula': 'Cédula', 'passport': 'Pasaporte', 'na': 'N/A' };

        const formatCurrency = (amount, currencyCode) => {
            const symbol = CURRENCIES[currencyCode]?.symbol || 'RD$';
            return `${symbol}${Math.abs(amount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        };

        // --- UI Components ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    iconRef.current.innerHTML = `<i data-lucide="${kebabName}" style="width: ${size}px; height: ${size}px;"></i>`;
                    window.lucide.createIcons({ attrs: { class: className, 'stroke-width': 2 }, nameAttr: 'data-lucide' });
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center leading-none" />;
        };

        const Card = ({ children, className = "", ...props }) => (
            <div className={`bg-white rounded-3xl border border-slate-100 shadow-sm ${className}`} {...props}>{children}</div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = "", icon, loading = false, type = "button", disabled = false }) => {
            const styles = {
                primary: 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-indigo-100 shadow-lg',
                secondary: 'bg-white text-slate-700 border border-slate-200 hover:bg-slate-50',
                danger: 'bg-red-50 text-red-600 hover:bg-red-100',
                ghost: 'text-slate-500 hover:bg-slate-100'
            };
            return (
                <button type={type} disabled={loading || disabled} onClick={onClick} className={`px-5 py-2.5 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 transition-all active:scale-95 disabled:opacity-50 ${styles[variant]} ${className}`}>
                    {loading ? <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : (icon && <Icon name={icon} size={18} />)}
                    {children}
                </button>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onClick={onClose}></div>
                    <Card className="relative w-full max-w-lg p-8 animate-slide-up shadow-2xl overflow-y-auto max-h-[90vh]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-black italic">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><Icon name="X" /></button>
                        </div>
                        {children}
                    </Card>
                </div>
            );
        };

        const Badge = ({ variant = 'default', children }) => {
            const styles = {
                success: 'bg-emerald-100 text-emerald-700',
                warning: 'bg-amber-100 text-amber-700',
                danger: 'bg-red-100 text-red-700',
                info: 'bg-blue-100 text-blue-700',
                default: 'bg-slate-100 text-slate-600'
            };
            return <span className={`px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider ${styles[variant] || styles.default}`}>{children}</span>;
        };

        // --- Login & Registration Screen ---
        const LoginScreen = ({ onLogin }) => {
            const [mode, setMode] = useState('select'); 
            const [selectedOrg, setSelectedOrg] = useState(null);
            const [companies, setCompanies] = useState([]);
            const [pin, setPin] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                const q = collection(db, 'artifacts', currentAppId, 'public', 'data', 'companies');
                const unsub = onSnapshot(q, (s) => {
                    const list = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    setCompanies(list);
                }, (err) => console.error("Error fetching companies:", err));
                return () => unsub();
            }, []);

            const handlePinSubmit = (e) => {
                e.preventDefault();
                const validPin = selectedOrg.staticPin;
                if (pin === validPin) {
                    onLogin(selectedOrg.id, selectedOrg.name);
                } else {
                    setError('PIN incorrecto. Intente de nuevo.');
                    setPin('');
                }
            };

            const handleCreateCompany = async (e) => {
                e.preventDefault();
                setLoading(true);
                const fd = new FormData(e.target);
                const payload = Object.fromEntries(fd.entries());
                
                if (payload.staticPin.length !== 4) {
                    alert("El PIN debe tener exactamente 4 dígitos.");
                    setLoading(false);
                    return;
                }

                try {
                    const slug = payload.name.toLowerCase().replace(/\s+/g, '-');
                    await addDoc(collection(db, 'artifacts', currentAppId, 'public', 'data', 'companies'), {
                        ...payload,
                        slug,
                        timestamp: Date.now(),
                        defaultCurrency: 'DOP'
                    });
                    setMode('select');
                    alert("Empresa creada exitosamente. Utilice su PIN para acceder.");
                } catch (e) {
                    alert("Error al crear empresa: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="h-screen w-full flex items-center justify-center bg-slate-50 px-6 overflow-y-auto">
                    <Card className={`w-full ${mode === 'create' ? 'max-w-2xl' : 'max-w-md'} p-10 shadow-2xl border-none my-8`}>
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-black italic text-indigo-950 uppercase tracking-tighter">LorHels ERP</h1>
                            <p className="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">Enterprise Management</p>
                        </div>

                        {mode === 'select' && (
                            <div className="space-y-4">
                                <p className="text-[10px] font-black uppercase text-slate-400 text-center tracking-widest">Seleccione su organización</p>
                                <div className="max-h-60 overflow-y-auto space-y-2 pr-1">
                                    {companies.map(c => (
                                        <button key={c.id} onClick={() => { setSelectedOrg(c); setMode('pin'); }} className="w-full p-4 bg-white border-2 border-slate-50 rounded-2xl hover:border-indigo-600 hover:bg-indigo-50 text-left flex justify-between items-center group transition-all">
                                            <div className="flex items-center gap-3">
                                                {c.logo ? <img src={c.logo} className="w-8 h-8 rounded-lg object-contain bg-slate-100" /> : <div className="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center font-bold text-xs">{c.name.charAt(0)}</div>}
                                                <span className="font-bold text-slate-700">{c.name}</span>
                                            </div>
                                            <Icon name="ChevronRight" className="text-slate-300 group-hover:text-indigo-600" />
                                        </button>
                                    ))}
                                    {companies.length === 0 && <p className="text-center py-4 text-slate-300 text-sm italic">No hay empresas registradas</p>}
                                </div>
                                <div className="pt-4 border-t border-slate-100">
                                    <Button variant="secondary" className="w-full" onClick={() => setMode('create')}>Crear Nueva Empresa</Button>
                                </div>
                            </div>
                        )}

                        {mode === 'pin' && (
                            <form onSubmit={handlePinSubmit} className="space-y-6 text-center animate-slide-up">
                                <div className="flex flex-col items-center gap-2">
                                    <p className="font-black text-indigo-600 uppercase tracking-widest text-lg">{selectedOrg.name}</p>
                                    <p className="text-[10px] font-bold text-slate-400 uppercase">Ingrese su PIN de acceso</p>
                                </div>
                                <input type="password" value={pin} onChange={e => setPin(e.target.value)} maxLength="4" placeholder="••••" className="w-full text-center text-4xl tracking-widest p-4 bg-slate-50 rounded-2xl font-black outline-none border-2 border-transparent focus:border-indigo-600 shadow-inner" required autoFocus />
                                {error && <p className="text-red-500 font-bold text-xs bg-red-50 p-2 rounded-lg">{error}</p>}
                                <div className="flex gap-4">
                                    <Button variant="ghost" className="flex-1" onClick={() => {setMode('select'); setError('');}}>Atrás</Button>
                                    <Button type="submit" className="flex-1">Acceder</Button>
                                </div>
                            </form>
                        )}

                        {mode === 'create' && (
                            <form onSubmit={handleCreateCompany} className="space-y-6 animate-slide-up">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-black text-slate-400 uppercase ml-2">Nombre de la Empresa</label>
                                        <input name="name" placeholder="Ej. LorHels Tech" className="w-full p-3 bg-slate-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none" required />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-black text-slate-400 uppercase ml-2">Representante</label>
                                        <input name="rep" placeholder="Nombre del encargado" className="w-full p-3 bg-slate-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none" required />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-black text-slate-400 uppercase ml-2">RNC / Cédula</label>
                                        <input name="rnc" placeholder="Identificación Fiscal" className="w-full p-3 bg-slate-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none" required />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-black text-slate-400 uppercase ml-2">Email Corporativo</label>
                                        <input name="email" type="email" placeholder="correo@empresa.com" className="w-full p-3 bg-slate-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none" required />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-black text-slate-400 uppercase ml-2">Num. de Contacto</label>
                                        <input name="phone" placeholder="809-000-0000" className="w-full p-3 bg-slate-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none" required />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-black text-slate-400 uppercase ml-2">Sitio Web</label>
                                        <input name="website" placeholder="www.empresa.com" className="w-full p-3 bg-slate-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none" />
                                    </div>
                                    <div className="md:col-span-2 space-y-1">
                                        <label className="text-[10px] font-black text-slate-400 uppercase ml-2">Dirección Física</label>
                                        <input name="address" placeholder="Calle, Ciudad, País" className="w-full p-3 bg-slate-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none" required />
                                    </div>
                                    <div className="md:col-span-2 space-y-1">
                                        <label className="text-[10px] font-black text-slate-400 uppercase ml-2">URL del Logo (Imagen)</label>
                                        <input name="logo" placeholder="https://ejemplo.com/logo.png" className="w-full p-3 bg-slate-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none" />
                                    </div>
                                    <div className="md:col-span-2 space-y-1 p-4 bg-indigo-50 rounded-2xl border border-indigo-100">
                                        <label className="text-[10px] font-black text-indigo-600 uppercase mb-2 block">Defina su PIN de Seguridad (4 dígitos)</label>
                                        <input name="staticPin" type="password" maxLength="4" placeholder="••••" className="w-full text-center text-2xl tracking-[1em] p-3 bg-white rounded-xl font-black border-2 border-transparent focus:border-indigo-600 outline-none shadow-sm" required />
                                        <p className="text-[9px] text-indigo-400 mt-2 italic">* Este código será solicitado cada vez que intente ingresar a su empresa.</p>
                                    </div>
                                </div>
                                <div className="flex gap-4 pt-4">
                                    <Button variant="ghost" className="flex-1" onClick={() => setMode('select')}>Cancelar</Button>
                                    <Button type="submit" className="flex-1" loading={loading}>Registrar Empresa</Button>
                                </div>
                            </form>
                        )}
                    </Card>
                </div>
            );
        };

        // --- App Component ---
        function App() {
            const [view, setView] = useState('billing');
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [actionLoading, setActionLoading] = useState(false);
            const [syncStatus, setSyncStatus] = useState('offline');
            
            const [companyId, setCompanyId] = useState(localStorage.getItem('lorhels_slug'));
            const [companyName, setCompanyName] = useState(localStorage.getItem('lorhels_name') || '');
            const [defaultCurrency, setDefaultCurrency] = useState('DOP');
            
            const [data, setData] = useState({ 
                clients: [], 
                taxes: [], 
                config: {}, 
                companyProfile: null, 
                products: [], 
                movements: [], 
                invoices: [],
                quotes: [] 
            });
            const [modal, setModal] = useState({ open: false, type: '', data: null });
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedClient, setSelectedClient] = useState(null);
            const [inventoryTab, setInventoryTab] = useState('existencias'); 
            const [billingTab, setBillingTab] = useState('facturas'); 

            // State for Billing Form
            const [billingForm, setBillingForm] = useState({
                type: 'factura', 
                clientId: '',
                clientName: '',
                currency: 'DOP',
                items: [],
                taxId: '',
                note: '',
                date: new Date().toISOString().split('T')[0]
            });
            
            // Visualisation modes
            const [clientViewMode, setClientViewMode] = useState('grid'); 
            const [inventoryViewMode, setInventoryViewMode] = useState('grid'); 

            // Auth listener
            useEffect(() => {
                const unsub = onAuthStateChanged(auth, u => {
                    if (!u) signInAnonymously(auth);
                    setUser(u); setLoading(false);
                });
                return () => unsub();
            }, []);

            // Data Fetching
            useEffect(() => {
                if (!user || !companyId) return;
                setSyncStatus('connecting');
                
                const companyRef = doc(db, 'artifacts', currentAppId, 'public', 'data', 'companies', companyId);

                const unsubs = [
                    onSnapshot(companyRef, (s) => {
                        if (s.exists()) {
                            const cdata = s.data();
                            setData(prev => ({ ...prev, companyProfile: { id: s.id, ...cdata } }));
                            setCompanyName(cdata.name);
                            if (cdata.defaultCurrency) {
                                setDefaultCurrency(cdata.defaultCurrency);
                                setBillingForm(prev => ({...prev, currency: cdata.defaultCurrency}));
                            }
                        }
                    }),
                    onSnapshot(collection(db, 'artifacts', currentAppId, 'public', 'data', 'clients'), s => setData(p => ({...p, clients: s.docs.map(d => ({id: d.id, ...d.data()}))}))),
                    onSnapshot(collection(db, 'artifacts', currentAppId, 'public', 'data', 'taxes'), s => setData(p => ({...p, taxes: s.docs.map(d => ({id: d.id, ...d.data()}))}))),
                    onSnapshot(collection(db, 'artifacts', currentAppId, 'public', 'data', 'products'), s => setData(p => ({...p, products: s.docs.map(d => ({id: d.id, ...d.data()}))}))),
                    onSnapshot(collection(db, 'artifacts', currentAppId, 'public', 'data', 'invoices'), s => setData(p => ({...p, invoices: s.docs.map(d => ({id: d.id, ...d.data()}))}))),
                    onSnapshot(collection(db, 'artifacts', currentAppId, 'public', 'data', 'quotes'), s => setData(p => ({...p, quotes: s.docs.map(d => ({id: d.id, ...d.data()}))}))),
                    onSnapshot(collection(db, 'artifacts', currentAppId, 'public', 'data', 'movements'), s => setData(p => ({...p, movements: s.docs.map(d => ({id: d.id, ...d.data()}))}))),
                ];
                setSyncStatus('online');
                return () => unsubs.forEach(u => u());
            }, [user, companyId]);

            const handleLogin = (id, name) => { 
                setCompanyId(id); 
                setCompanyName(name); 
                localStorage.setItem('lorhels_slug', id); 
                localStorage.setItem('lorhels_name', name); 
            };

            const handleLogout = () => { 
                setCompanyId(null); 
                setCompanyName(''); 
                localStorage.clear(); 
            };

            const handleViewClient = (client) => { setSelectedClient(client); setView('client_detail'); };

            const saveData = async (type, payload) => {
                if (!user || !companyId) return;
                setActionLoading(true);
                try {
                    const cleanPayload = { ...payload, timestamp: Date.now(), createdBy: user.uid };
                    const collectionName = type === 'tax' ? 'taxes' : type + 's';

                    if (payload.id) {
                        const docRef = doc(db, 'artifacts', currentAppId, 'public', 'data', collectionName, payload.id);
                        const { id, ...dataUpdate } = cleanPayload;
                        await updateDoc(docRef, dataUpdate);
                    } else {
                        if (type === 'product') {
                            cleanPayload.averageCost = parseFloat(payload.purchasePrice) || 0;
                            cleanPayload.stock = parseInt(payload.stock) || 0;
                        }
                        await addDoc(collection(db, 'artifacts', currentAppId, 'public', 'data', collectionName), cleanPayload);
                    }
                    setModal({ open: false, type: '', data: null });
                } catch (e) { alert(e.message); } finally { setActionLoading(false); }
            };

            const adjustStock = async (e) => {
                e.preventDefault();
                setActionLoading(true);
                const fd = new FormData(e.target);
                const payload = Object.fromEntries(fd.entries());
                const product = modal.data;
                const qty = parseInt(payload.quantity);
                const isEntry = payload.moveType === 'ENTRADA';
                
                try {
                    const newStock = isEntry ? (parseInt(product.stock) + qty) : (parseInt(product.stock) - qty);
                    let newAverageCost = parseFloat(product.averageCost) || 0;

                    if (isEntry && newStock > 0) {
                        const newCost = parseFloat(payload.cost) || 0;
                        newAverageCost = ((product.stock * product.averageCost) + (qty * newCost)) / newStock;
                    }

                    const prodRef = doc(db, 'artifacts', currentAppId, 'public', 'data', 'products', product.id);
                    await updateDoc(prodRef, {
                        stock: newStock,
                        averageCost: newAverageCost,
                        purchasePrice: isEntry ? (parseFloat(payload.cost) || product.purchasePrice) : product.purchasePrice
                    });

                    await addDoc(collection(db, 'artifacts', currentAppId, 'public', 'data', 'movements'), {
                        productId: product.id,
                        productName: product.name,
                        type: payload.moveType,
                        quantity: qty,
                        reason: payload.reason,
                        cost: isEntry ? parseFloat(payload.cost) : newAverageCost,
                        stockAfter: newStock,
                        date: new Date().toISOString().split('T')[0],
                        timestamp: Date.now()
                    });

                    setModal({ open: false, type: '', data: null });
                } catch (e) {
                    alert(e.message);
                } finally {
                    setActionLoading(false);
                }
            };

            // Billing Logic
            const addItemToBilling = (product) => {
                const existing = billingForm.items.find(i => i.id === product.id);
                if (existing) {
                    setBillingForm({
                        ...billingForm,
                        items: billingForm.items.map(i => i.id === product.id ? {...i, qty: i.qty + 1} : i)
                    });
                } else {
                    setBillingForm({
                        ...billingForm,
                        items: [...billingForm.items, {
                            id: product.id,
                            name: product.name,
                            price: parseFloat(product.salePrice) || 0,
                            qty: 1,
                            currency: product.currency || defaultCurrency,
                            trackStock: product.trackStock !== false
                        }]
                    });
                }
            };

            const calculateBillingTotals = () => {
                const subtotal = billingForm.items.reduce((acc, item) => acc + (item.price * item.qty), 0);
                const selectedTax = data.taxes.find(t => t.id === billingForm.taxId);
                const taxAmount = selectedTax ? (subtotal * (parseFloat(selectedTax.rate) / 100)) : 0;
                return { subtotal, taxAmount, total: subtotal + taxAmount };
            };

            const processBilling = async () => {
                if (!billingForm.clientId || billingForm.items.length === 0) {
                    alert("Seleccione un cliente y añada al menos un producto.");
                    return;
                }
                setActionLoading(true);
                const totals = calculateBillingTotals();
                const collectionName = billingForm.type === 'factura' ? 'invoices' : 'quotes';
                
                try {
                    const docPayload = {
                        clientId: billingForm.clientId || '',
                        clientName: billingForm.clientName || '',
                        date: billingForm.date || new Date().toISOString().split('T')[0],
                        currency: billingForm.currency || defaultCurrency,
                        items: billingForm.items.map(it => ({
                            id: it.id || '',
                            name: it.name || '',
                            price: parseFloat(it.price) || 0,
                            qty: parseInt(it.qty) || 1,
                            currency: it.currency || billingForm.currency,
                            trackStock: !!it.trackStock
                        })),
                        taxId: billingForm.taxId || '',
                        taxAmount: parseFloat(totals.taxAmount) || 0,
                        subtotal: parseFloat(totals.subtotal) || 0,
                        total: parseFloat(totals.total) || 0,
                        note: billingForm.note || '',
                        status: billingForm.type === 'factura' ? 'pendiente' : 'abierta',
                        timestamp: Date.now()
                    };

                    const docRef = await addDoc(collection(db, 'artifacts', currentAppId, 'public', 'data', collectionName), docPayload);

                    if (billingForm.type === 'factura') {
                        for (const item of billingForm.items) {
                            if (item.trackStock) {
                                const prodRef = doc(db, 'artifacts', currentAppId, 'public', 'data', 'products', item.id);
                                const prodSnap = await getDoc(prodRef);
                                if (prodSnap.exists()) {
                                    const currentStock = parseInt(prodSnap.data().stock) || 0;
                                    await updateDoc(prodRef, { stock: currentStock - item.qty });
                                    
                                    await addDoc(collection(db, 'artifacts', currentAppId, 'public', 'data', 'movements'), {
                                        productId: item.id,
                                        productName: item.name,
                                        type: 'SALIDA',
                                        quantity: item.qty,
                                        reason: `Venta - Factura #${docRef.id.substring(0,6)}`,
                                        stockAfter: currentStock - item.qty,
                                        date: billingForm.date,
                                        timestamp: Date.now()
                                    });
                                }
                            }
                        }
                    }

                    alert(`${billingForm.type === 'factura' ? 'Factura' : 'Cotización'} generada con éxito.`);
                    setView('billing');
                    // Reset billing form
                    setBillingForm({
                        type: 'factura', clientId: '', clientName: '', currency: defaultCurrency, items: [], taxId: '', note: '', date: new Date().toISOString().split('T')[0]
                    });
                } catch (e) {
                    console.error(e);
                    alert("Error al procesar: " + e.message);
                } finally {
                    setActionLoading(false);
                }
            };

            const convertQuoteToInvoice = async (quote) => {
                if (!confirm(`¿Convertir cotización de ${quote.clientName} en factura?`)) return;
                setActionLoading(true);
                try {
                    const invoicePayload = {
                        clientId: quote.clientId || '',
                        clientName: quote.clientName || '',
                        date: new Date().toISOString().split('T')[0],
                        currency: quote.currency || defaultCurrency,
                        items: (quote.items || []).map(it => ({
                            id: it.id || '',
                            name: it.name || '',
                            price: parseFloat(it.price) || 0,
                            qty: parseInt(it.qty) || 1,
                            currency: it.currency || quote.currency || defaultCurrency,
                            trackStock: !!it.trackStock
                        })),
                        taxId: quote.taxId || '',
                        taxAmount: parseFloat(quote.taxAmount) || 0,
                        subtotal: parseFloat(quote.subtotal) || 0,
                        total: parseFloat(quote.total) || 0,
                        note: quote.note || '',
                        type: 'factura',
                        status: 'pendiente',
                        timestamp: Date.now(),
                        quoteId: quote.id
                    };

                    const docRef = await addDoc(collection(db, 'artifacts', currentAppId, 'public', 'data', 'invoices'), invoicePayload);
                    await updateDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'quotes', quote.id), { status: 'facturada' });

                    for (const item of invoicePayload.items) {
                        if (item.trackStock) {
                            const prodRef = doc(db, 'artifacts', currentAppId, 'public', 'data', 'products', item.id);
                            const prodSnap = await getDoc(prodRef);
                            if (prodSnap.exists()) {
                                const currentStock = parseInt(prodSnap.data().stock) || 0;
                                await updateDoc(prodRef, { stock: currentStock - item.qty });
                                await addDoc(collection(db, 'artifacts', currentAppId, 'public', 'data', 'movements'), {
                                    productId: item.id,
                                    productName: item.name,
                                    type: 'SALIDA',
                                    quantity: item.qty,
                                    reason: `Venta (vía Cotización) - Factura #${docRef.id.substring(0,6)}`,
                                    stockAfter: currentStock - item.qty,
                                    date: invoicePayload.date,
                                    timestamp: Date.now()
                                });
                            }
                        }
                    }
                    alert("Cotización facturada con éxito.");
                    setBillingTab('facturas');
                } catch (e) { alert(e.message); } finally { setActionLoading(false); }
            };

            const getClientFinancials = (clientName) => {
                const clientInvoices = (data.invoices || []).filter(i => 
                    i.clientName === clientName && 
                    i.status !== 'anulada'
                );

                const debtByCurrency = clientInvoices.reduce((acc, inv) => {
                    const curr = inv.currency || defaultCurrency;
                    if (inv.status === 'pendiente' || inv.status === 'parcial') {
                        acc[curr] = (acc[curr] || 0) + (inv.total - (inv.paidAmount || 0));
                    }
                    return acc;
                }, {});

                return { clientInvoices, debtByCurrency };
            };

            const generateStatementPDF = (client, invoices) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const primaryColor = [79, 70, 229];

                doc.setFontSize(22);
                doc.setTextColor(...primaryColor);
                doc.setFont("helvetica", "bold");
                doc.text(companyName, 20, 25);

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.setFont("helvetica", "normal");
                doc.text("Estado de Cuenta de Cliente", 20, 32);
                doc.text(`Fecha de Emisión: ${new Date().toISOString().split('T')[0]}`, 190, 32, { align: "right" });

                doc.setFillColor(248, 250, 252);
                doc.rect(20, 42, 170, 45, 'F');
                
                doc.setFontSize(11);
                doc.setTextColor(0);
                doc.setFont("helvetica", "bold");
                doc.text("DATOS DEL CLIENTE", 25, 50);
                
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`Nombre: ${client.name || 'S/N'}`, 25, 58);
                doc.text(`${DOC_TYPES[client.docType] || 'Identificación'}: ${client.rnc || 'S/N'}`, 25, 64);
                doc.text(`Tel: ${client.phone || '-'}`, 25, 70);
                doc.text(`Email: ${client.email || '-'}`, 25, 76);
                doc.text(`Dir: ${client.address || '-'}`, 25, 82);

                doc.setFontSize(10);
                doc.setTextColor(...primaryColor);
                doc.setFont("helvetica", "bold");
                doc.text(`LÍMITE CRÉDITO: ${formatCurrency(client.creditLimit, client.currency || defaultCurrency)}`, 190, 50, { align: "right" });

                const tableColumn = ["Fecha", "Documento", "Monto", "Pendiente", "Estado"];
                const tableRows = invoices.map(inv => {
                    const pending = inv.total - (inv.paidAmount || 0);
                    return [
                        inv.date || '-',
                        inv.id ? inv.id.substring(0,8) : '-',
                        formatCurrency(inv.total, inv.currency),
                        formatCurrency(pending, inv.currency),
                        (inv.status || 'S/E').toUpperCase()
                    ];
                });

                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 95, theme: 'grid' });

                const finalY = doc.lastAutoTable.finalY + 15;
                doc.setFontSize(12); doc.setTextColor(0); doc.text("RESUMEN DE DEUDA:", 20, finalY);

                const { debtByCurrency } = getClientFinancials(client.name);
                let currentY = finalY + 8;
                Object.entries(debtByCurrency).forEach(([curr, val]) => {
                    doc.setFontSize(14); doc.setTextColor(220, 38, 38);
                    doc.text(`${curr}: ${formatCurrency(val, curr)}`, 20, currentY);
                    currentY += 8;
                });

                doc.save(`Estado_Cuenta_${client.name}.pdf`);
            };

            const generateDocPDF = (document, typeLabel) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const primaryColor = [79, 70, 229];

                // Buscar data extendida del cliente en el estado actual de la app
                const clientInfo = data.clients.find(c => c.id === document.clientId) || {};

                // Header
                doc.setFontSize(22);
                doc.setTextColor(...primaryColor);
                doc.setFont("helvetica", "bold");
                doc.text(companyName, 20, 25);

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.setFont("helvetica", "normal");
                doc.text(typeLabel.toUpperCase(), 20, 32);
                doc.text(`Número: #${document.id ? document.id.substring(0,8) : 'S/N'}`, 190, 25, { align: "right" });
                doc.text(`Fecha: ${document.date || '-'}`, 190, 32, { align: "right" });

                // Client Info Section (Caja Gris)
                doc.setFillColor(248, 250, 252);
                doc.rect(20, 42, 170, 42, 'F');
                doc.setFontSize(11);
                doc.setTextColor(0);
                doc.setFont("helvetica", "bold");
                doc.text("CLIENTE:", 25, 50);
                
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`${document.clientName || 'S/N'}`, 25, 58);
                doc.text(`${DOC_TYPES[clientInfo.docType] || 'Identificación'}: ${clientInfo.rnc || 'S/N'}`, 25, 64);
                doc.text(`Tel: ${clientInfo.phone || '-'} | Email: ${clientInfo.email || '-'}`, 25, 70);
                doc.text(`Dirección: ${clientInfo.address || '-'}`, 25, 76);
                
                doc.text(`Moneda: ${document.currency || defaultCurrency}`, 190, 58, { align: "right" });

                // Items Table
                const tableColumn = ["Descripción", "Cant.", "Precio", "Total"];
                const tableRows = (document.items || []).map(item => [
                    item.name || 'S/N',
                    item.qty || 0,
                    formatCurrency(item.price, document.currency),
                    formatCurrency((item.qty || 0) * (item.price || 0), document.currency)
                ]);

                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 90, theme: 'grid' });

                // Totals
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(10);
                doc.text(`Subtotal: ${formatCurrency(document.subtotal, document.currency)}`, 190, finalY, { align: "right" });
                doc.text(`Impuesto: ${formatCurrency(document.taxAmount, document.currency)}`, 190, finalY + 7, { align: "right" });
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text(`TOTAL: ${formatCurrency(document.total, document.currency)}`, 190, finalY + 17, { align: "right" });

                if (document.note) {
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "italic");
                    doc.text("Notas:", 20, finalY + 30);
                    doc.text(document.note, 20, finalY + 37);
                }

                doc.save(`${typeLabel}_${document.clientName || 'Doc'}.pdf`);
            };

            const updateCompanyProfile = async (e) => {
                e.preventDefault();
                setActionLoading(true);
                const fd = new FormData(e.target);
                const payload = Object.fromEntries(fd.entries());
                try {
                    const docRef = doc(db, 'artifacts', currentAppId, 'public', 'data', 'companies', companyId);
                    await updateDoc(docRef, payload);
                    alert("Configuración de empresa actualizada.");
                } catch (e) {
                    alert("Error: " + e.message);
                } finally {
                    setActionLoading(false);
                }
            };

            const deleteData = async (type, id) => {
                if (!confirm('¿Seguro que desea eliminar?')) return;
                const collectionName = type === 'tax' ? 'taxes' : type + 's';
                try { await deleteDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', collectionName, id)); } catch (e) { console.error(e); }
            };

            const filteredClients = data.clients.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()) || (c.rnc && c.rnc.includes(searchTerm)));
            const filteredProducts = data.products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()) || (p.code && p.code.toLowerCase().includes(searchTerm.toLowerCase())));

            if (loading) return <div className="h-screen flex items-center justify-center bg-white"><div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div></div>;
            if (!companyId) return <LoginScreen onLogin={handleLogin} />;

            return (
                <div className="flex h-screen w-full relative bg-[#f8fafc]">
                    <aside className={`${sidebarOpen ? 'w-80' : 'w-24'} bg-white border-r border-slate-100 sidebar-transition flex flex-col z-30 shadow-2xl`}>
                        <div className="p-10 flex items-center gap-4 overflow-hidden">
                            <div className="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white transform -rotate-6 shadow-xl font-black text-xl italic">LH</div>
                            {sidebarOpen && <h1 className="font-black text-2xl uppercase tracking-tighter text-indigo-950">LorHels</h1>}
                        </div>
                        <nav className="flex-grow px-6 space-y-2 overflow-y-auto">
                            {[
                                { id: 'billing', label: 'Facturación', icon: 'FileText' },
                                { id: 'inventory', label: 'Inventario', icon: 'Package' },
                                { id: 'clients', label: 'Clientes', icon: 'Users' },
                                { id: 'settings', label: 'Configuración', icon: 'Settings' }
                            ].map(item => (
                                <button key={item.id} onClick={() => {setView(item.id); setSelectedClient(null);}} className={`w-full flex items-center gap-4 px-5 py-4 rounded-2xl transition-all ${view === item.id || (view === 'billing_form' && item.id === 'billing') || (view === 'client_detail' && item.id === 'clients') ? 'bg-indigo-600 text-white shadow-xl' : 'text-slate-400 hover:bg-indigo-50 hover:text-indigo-600'}`}>
                                    {sidebarOpen ? <span className="font-bold text-sm">{item.label}</span> : <span className="font-bold text-xs uppercase tracking-tighter mx-auto">{item.label.charAt(0)}</span>}
                                </button>
                            ))}
                        </nav>
                        <div className="p-8 space-y-4">
                            <button onClick={handleLogout} className="w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-red-400 hover:bg-red-50 font-bold text-sm transition-all">
                                {sidebarOpen ? "Cerrar Empresa" : <Icon name="LogOut" size={18} className="mx-auto" />}
                            </button>
                            <button onClick={() => setSidebarOpen(!sidebarOpen)} className="w-full flex items-center justify-center p-4 bg-slate-50 rounded-2xl text-slate-400">
                                <Icon name="ChevronRight" className={sidebarOpen ? 'rotate-180' : ''} />
                            </button>
                        </div>
                    </aside>

                    <main className="flex-grow flex flex-col overflow-hidden">
                        <header className="h-28 glass border-b border-slate-100 flex items-center justify-between px-12 sticky top-0 z-20">
                            <div className="flex items-center gap-4">
                                {data.companyProfile?.logo && <img src={data.companyProfile.logo} className="w-12 h-12 rounded-xl object-contain bg-white shadow-sm" />}
                                <div>
                                    <div className="flex items-center gap-2">
                                        <div className={`w-2.5 h-2.5 rounded-full ${syncStatus === 'online' ? 'bg-emerald-500' : 'bg-red-500 animate-pulse'}`}></div>
                                        <p className="text-2xl font-black text-slate-800 uppercase italic leading-none">{companyName}</p>
                                    </div>
                                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">Módulo de Administración • {CURRENCIES[defaultCurrency]?.symbol}</p>
                                </div>
                            </div>
                        </header>

                        <div className="flex-grow overflow-y-auto p-12 custom-shadow">
                            <div className="max-w-7xl mx-auto pb-20">
                                
                                {view === 'billing' && (
                                    <div className="space-y-8 animate-slide-up">
                                        <div className="flex flex-col md:flex-row justify-between items-end md:items-center gap-4">
                                            <div>
                                                <h2 className="text-4xl font-black italic text-indigo-950">Facturación</h2>
                                                <div className="flex gap-4 mt-4 border-b border-slate-200">
                                                    <button onClick={() => setBillingTab('facturas')} className={`pb-2 px-4 font-bold text-sm transition-all ${billingTab === 'facturas' ? 'border-b-4 border-indigo-600 text-indigo-600' : 'text-slate-400'}`}>Facturas</button>
                                                    <button onClick={() => setBillingTab('cotizaciones')} className={`pb-2 px-4 font-bold text-sm transition-all ${billingTab === 'cotizaciones' ? 'border-b-4 border-indigo-600 text-indigo-600' : 'text-slate-400'}`}>Cotizaciones</button>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <Button icon="Plus" onClick={() => setView('billing_form')}>Nueva Factura / Cotización</Button>
                                            </div>
                                        </div>

                                        <Card className="overflow-hidden">
                                            <table className="w-full text-left text-sm">
                                                <thead className="bg-slate-50 text-[10px] uppercase font-black text-slate-400">
                                                    <tr>
                                                        <th className="p-4">Fecha</th>
                                                        <th className="p-4">Cliente</th>
                                                        <th className="p-4">Total</th>
                                                        <th className="p-4">Estado</th>
                                                        <th className="p-4 text-center">Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {(billingTab === 'facturas' ? data.invoices : data.quotes).map(docItem => (
                                                        <tr key={docItem.id} className="hover:bg-slate-50 transition-all">
                                                            <td className="p-4 font-mono text-xs">{docItem.date}</td>
                                                            <td className="p-4 font-bold">{docItem.clientName}</td>
                                                            <td className="p-4 font-black">{formatCurrency(docItem.total, docItem.currency)}</td>
                                                            <td className="p-4">
                                                                <Badge variant={
                                                                    docItem.status === 'facturada' || docItem.status === 'pagada' ? 'success' : 
                                                                    docItem.status === 'pendiente' || docItem.status === 'abierta' ? 'warning' : 'default'
                                                                }>
                                                                    {docItem.status}
                                                                </Badge>
                                                            </td>
                                                            <td className="p-4 text-center">
                                                                <div className="flex justify-center gap-3">
                                                                    <button onClick={() => generateDocPDF(docItem, billingTab === 'facturas' ? 'Factura' : 'Cotizacion')} className="text-slate-300 hover:text-indigo-600" title="Descargar PDF"><Icon name="FileDown" size={18} /></button>
                                                                    {billingTab === 'cotizaciones' && docItem.status === 'abierta' && (
                                                                        <button onClick={() => convertQuoteToInvoice(docItem)} className="text-emerald-300 hover:text-emerald-600" title="Convertir en Factura"><Icon name="CheckCircle" size={18} /></button>
                                                                    )}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    {(billingTab === 'facturas' ? data.invoices : data.quotes).length === 0 && (
                                                        <tr><td colSpan="5" className="p-20 text-center text-slate-300 italic font-bold">No hay registros en esta sección.</td></tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </Card>
                                    </div>
                                )}

                                {view === 'billing_form' && (
                                    <div className="animate-slide-up space-y-8">
                                        <div className="flex items-center gap-4">
                                            <button onClick={() => setView('billing')} className="p-3 bg-white rounded-xl border border-slate-200 hover:bg-slate-50 text-slate-500 transition-all"><Icon name="ArrowLeft" size={20} /></button>
                                            <h2 className="text-3xl font-black italic text-indigo-950 uppercase tracking-tighter">Crear Documento</h2>
                                        </div>

                                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                            <div className="lg:col-span-1 space-y-6">
                                                <Card className="p-8 space-y-6">
                                                    <div>
                                                        <label className="text-[10px] font-black text-slate-400 uppercase block mb-2">Tipo de Documento</label>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => setBillingForm({...billingForm, type: 'factura'})} className={`flex-1 p-3 rounded-xl font-bold text-sm border-2 transition-all ${billingForm.type === 'factura' ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-100 text-slate-400'}`}>Factura</button>
                                                            <button onClick={() => setBillingForm({...billingForm, type: 'cotizacion'})} className={`flex-1 p-3 rounded-xl font-bold text-sm border-2 transition-all ${billingForm.type === 'cotizacion' ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-100 text-slate-400'}`}>Cotización</button>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-black text-slate-400 uppercase block mb-2">Cliente</label>
                                                        <select value={billingForm.clientId} onChange={(e) => { const c = data.clients.find(cl => cl.id === e.target.value); setBillingForm({...billingForm, clientId: e.target.value, clientName: c?.name || ''}); }} className="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-indigo-500">
                                                            <option value="">Seleccione un cliente...</option>
                                                            {data.clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-black text-slate-400 uppercase block mb-2">Impuesto Aplicable</label>
                                                        <select value={billingForm.taxId} onChange={(e) => setBillingForm({...billingForm, taxId: e.target.value})} className="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-indigo-500">
                                                            <option value="">Sin Impuesto</option>
                                                            {data.taxes.map(t => <option key={t.id} value={t.id}>{t.name} ({t.rate}%)</option>)}
                                                        </select>
                                                    </div>
                                                    <div className="pt-6 border-t border-slate-100 space-y-4">
                                                        {(() => { const { subtotal, taxAmount, total } = calculateBillingTotals(); return (<><div className="flex justify-between text-sm font-bold text-slate-400"><span>Subtotal</span><span>{formatCurrency(subtotal, billingForm.currency)}</span></div><div className="flex justify-between text-sm font-bold text-slate-400"><span>Impuestos</span><span>{formatCurrency(taxAmount, billingForm.currency)}</span></div><div className="flex justify-between text-xl font-black text-indigo-950 pt-2 border-t border-slate-50"><span>TOTAL</span><span>{formatCurrency(total, billingForm.currency)}</span></div></>); })()}
                                                    </div>
                                                    <Button onClick={processBilling} className="w-full py-4 uppercase font-black" loading={actionLoading}>Generar {billingForm.type === 'factura' ? 'Factura' : 'Cotización'}</Button>
                                                </Card>
                                            </div>
                                            <div className="lg:col-span-2 space-y-6">
                                                <Card className="p-8">
                                                    <div className="flex justify-between items-center mb-6">
                                                        <h4 className="font-black text-indigo-950 uppercase tracking-tight">Artículos / Servicios</h4>
                                                        <div className="relative w-64"><Icon name="Search" size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-300" /><input type="text" placeholder="Buscar en inventario..." onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-9 pr-4 py-2 bg-slate-50 rounded-xl text-xs font-bold focus:outline-none focus:ring-2 focus:ring-indigo-500/20" /></div>
                                                    </div>
                                                    <div className="max-h-60 overflow-y-auto mb-8 border border-slate-50 rounded-2xl p-2 bg-slate-50/30">
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                            {filteredProducts.map(p => (
                                                                <button key={p.id} onClick={() => addItemToBilling(p)} className="p-3 bg-white rounded-xl border border-slate-100 hover:border-indigo-300 flex justify-between items-center text-left transition-all group"><div><p className="font-bold text-slate-700 text-sm">{p.name}</p><p className="text-[10px] text-slate-400 font-mono">{formatCurrency(p.salePrice, p.currency || defaultCurrency)}</p></div><Icon name="PlusCircle" className="text-slate-200 group-hover:text-indigo-500" size={18} /></button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    <div className="space-y-3">
                                                        <p className="text-[10px] font-black text-slate-300 uppercase tracking-widest px-2">Detalle del documento</p>
                                                        {billingForm.items.map(item => (
                                                            <div key={item.id} className="flex items-center gap-4 p-4 bg-white rounded-2xl border border-slate-100 shadow-sm animate-slide-up"><div className="flex-grow"><p className="font-bold text-slate-800">{item.name}</p><p className="text-xs text-slate-400 font-bold">{formatCurrency(item.price, item.currency)} x {item.qty}</p></div><div className="flex items-center gap-2 bg-slate-50 p-1 rounded-xl"><button onClick={() => setBillingForm({...billingForm, items: billingForm.items.map(i => i.id === item.id ? {...i, qty: Math.max(1, i.qty - 1)} : i)})} className="w-8 h-8 flex items-center justify-center bg-white rounded-lg text-slate-400 hover:text-indigo-600 shadow-sm"><Icon name="Minus" size={14}/></button><span className="w-8 text-center font-black text-sm">{item.qty}</span><button onClick={() => setBillingForm({...billingForm, items: billingForm.items.map(i => i.id === item.id ? {...i, qty: i.qty + 1} : i)})} className="w-8 h-8 flex items-center justify-center bg-white rounded-lg text-slate-400 hover:text-indigo-600 shadow-sm"><Icon name="Plus" size={14}/></button></div><button onClick={() => setBillingForm({...billingForm, items: billingForm.items.filter(i => i.id !== item.id)})} className="text-red-300 hover:text-red-500 p-2"><Icon name="Trash2" size={18} /></button></div>
                                                        ))}
                                                        {billingForm.items.length === 0 && <div className="py-12 border-2 border-dashed border-slate-100 rounded-3xl text-center"><p className="text-slate-300 text-sm font-bold italic">No hay productos seleccionados.</p></div>}
                                                    </div>
                                                </Card>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {view === 'clients' && (
                                    <div className="space-y-8 animate-slide-up">
                                        <div className="flex flex-col md:flex-row justify-between items-end md:items-center gap-4">
                                            <div>
                                                <h2 className="text-4xl font-black italic text-indigo-950">Mis Clientes</h2>
                                                <p className="text-slate-500 font-medium mt-1 uppercase text-[10px] tracking-widest">Base de datos corporativa</p>
                                            </div>
                                            <div className="flex items-center gap-3 w-full md:w-auto">
                                                <div className="relative flex-grow md:w-64"><Icon name="Search" size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" /><input type="text" placeholder="Buscar cliente..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-bold focus:outline-none focus:border-indigo-500 transition-all shadow-sm" /></div>
                                                <div className="bg-white p-1 rounded-xl border border-slate-100 flex shadow-sm"><button onClick={() => setClientViewMode('grid')} className={`p-2 rounded-lg ${clientViewMode === 'grid' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-300'}`}><Icon name="LayoutGrid" size={20} /></button><button onClick={() => setClientViewMode('list')} className={`p-2 rounded-lg ${clientViewMode === 'list' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-300'}`}><Icon name="List" size={20} /></button></div>
                                                <Button icon="Plus" onClick={() => setModal({ open: true, type: 'client', data: null })}>Nuevo Cliente</Button>
                                            </div>
                                        </div>
                                        {clientViewMode === 'grid' ? (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">{filteredClients.map(c => (<Card key={c.id} className="p-8 group hover:border-indigo-300 cursor-pointer transition-all" onClick={() => handleViewClient(c)}><div className="flex justify-between items-start mb-6"><div className="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-3xl font-black">{c.name?.charAt(0)}</div><div className="flex gap-1"><button onClick={(e) => { e.stopPropagation(); setModal({ open: true, type: 'client', data: c }); }} className="p-2 text-slate-200 hover:text-indigo-500 transition-colors"><Icon name="Pencil" size={18} /></button><button onClick={(e) => { e.stopPropagation(); deleteData('client', c.id); }} className="p-2 text-slate-200 hover:text-red-500 transition-colors"><Icon name="Trash2" size={18} /></button></div></div><h4 className="font-bold text-xl text-slate-800">{c.name}</h4><p className="text-xs font-bold text-slate-400 mt-1">{c.rnc || 'S/N'}</p><div className="mt-6 pt-6 border-t border-slate-50 flex justify-between items-center"><div><p className="text-[9px] uppercase text-slate-300 font-black">Límite Crédito</p><p className="font-black text-emerald-600">{formatCurrency(c.creditLimit, c.currency || defaultCurrency)}</p></div><Icon name="ChevronRight" size={16} className="text-slate-300 group-hover:text-indigo-600 transition-all" /></div></Card>))}</div>) : (<Card className="overflow-hidden"><table className="w-full text-left text-sm"><thead className="bg-slate-50 text-[10px] uppercase font-black text-slate-400"><tr><th className="p-4">Cliente</th><th className="p-4">Identificación</th><th className="p-4">Tipo</th><th className="p-4 text-right">Límite Crédito</th><th className="p-4 text-center">Acciones</th></tr></thead><tbody className="divide-y divide-slate-100">{filteredClients.map(c => (<tr key={c.id} className="hover:bg-slate-50 transition-colors cursor-pointer" onClick={() => handleViewClient(c)}><td className="p-4"><div className="flex items-center gap-3"><div className="w-8 h-8 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center font-bold text-xs">{c.name?.charAt(0)}</div><span className="font-bold text-slate-700">{c.name}</span></div></td><td className="p-4 font-mono text-slate-500 text-xs">{c.rnc || 'S/N'}</td><td className="p-4 text-slate-400 text-xs font-bold uppercase">{CLIENT_TYPES[c.type]?.label || '-'}</td><td className="p-4 text-right font-black text-emerald-600">{formatCurrency(c.creditLimit, c.currency)}</td><td className="p-4 text-center"><div className="flex justify-center gap-2"><button onClick={(e) => { e.stopPropagation(); setModal({ open: true, type: 'client', data: c }); }} className="text-slate-300 hover:text-indigo-600"><Icon name="Pencil" size={16} /></button><button onClick={(e) => { e.stopPropagation(); deleteData('client', c.id); }} className="text-slate-300 hover:text-red-500"><Icon name="Trash2" size={16} /></button></div></td></tr>))}</tbody></table></Card>)}
                                        {filteredClients.length === 0 && <p className="col-span-full text-center py-20 text-slate-400 italic">No se encontraron clientes.</p>}
                                    </div>
                                )}

                                {view === 'client_detail' && selectedClient && (
                                    <div className="animate-slide-up space-y-8">
                                        <div className="flex items-center gap-4"><button onClick={() => setView('clients')} className="p-3 bg-white rounded-xl border border-slate-200 hover:bg-slate-50 text-slate-500 transition-all"><Icon name="ArrowLeft" size={20} /></button><div><h2 className="text-3xl font-black italic text-indigo-950">{selectedClient.name}</h2><div className="flex gap-2 items-center text-sm text-slate-500 font-bold"><span>{selectedClient.rnc}</span><span>•</span><span>{CLIENT_TYPES[selectedClient.type]?.label}</span></div></div><div className="ml-auto flex gap-2"><Button onClick={() => setModal({ open: true, type: 'client', data: selectedClient })} variant="secondary">Editar Perfil</Button><Button onClick={() => { const { clientInvoices } = getClientFinancials(selectedClient.name); generateStatementPDF(selectedClient, clientInvoices); }} icon="FileDown">Estado de Cuenta</Button></div></div>
                                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8"><Card className="p-8 lg:col-span-1 h-fit"><h4 className="text-lg font-black text-indigo-950 mb-6 uppercase tracking-tight">Información</h4><div className="space-y-4"><div><p className="text-[10px] font-bold text-slate-400 uppercase">Teléfono</p><p className="font-bold text-slate-700">{selectedClient.phone || '-'}</p></div><div><p className="text-[10px] font-bold text-slate-400 uppercase">Email</p><p className="font-bold text-slate-700">{selectedClient.email || '-'}</p></div><div><p className="text-[10px] font-bold text-slate-400 uppercase">Dirección</p><p className="font-bold text-slate-700">{selectedClient.address || '-'}</p></div></div></Card><div className="lg:col-span-2 space-y-6"><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><Card className="p-6 border-l-8 border-emerald-500"><p className="text-[10px] font-black uppercase text-slate-400 mb-1 tracking-widest">Límite de Crédito</p><h3 className="text-3xl font-black text-emerald-700">{formatCurrency(selectedClient.creditLimit, selectedClient.currency || defaultCurrency)}</h3></Card><Card className="p-6 border-l-8 border-red-500"><p className="text-[10px] font-black uppercase text-slate-400 mb-1 tracking-widest">Balance Pendiente (CxC)</p>{(() => { const { debtByCurrency } = getClientFinancials(selectedClient.name); const currencies = Object.keys(debtByCurrency); if (currencies.length === 0) return <h3 className="text-3xl font-black text-slate-300">{CURRENCIES[defaultCurrency]?.symbol}0.00</h3>; return currencies.map(curr => <div key={curr} className="text-2xl font-black text-red-600">{formatCurrency(debtByCurrency[curr], curr)}</div>); })()}</Card></div></div></div>
                                    </div>
                                )}

                                {view === 'inventory' && (
                                    <div className="space-y-8 animate-slide-up">
                                        <div className="flex flex-col md:flex-row justify-between items-end md:items-center gap-4"><div><h2 className="text-4xl font-black italic text-indigo-950">Inventario</h2><div className="flex gap-4 mt-4 border-b border-slate-200"><button onClick={() => setInventoryTab('existencias')} className={`pb-2 px-4 font-bold text-sm transition-all ${inventoryTab === 'existencias' ? 'border-b-4 border-indigo-600 text-indigo-600' : 'text-slate-400'}`}>Existencias</button><button onClick={() => setInventoryTab('movimientos')} className={`pb-2 px-4 font-bold text-sm transition-all ${inventoryTab === 'movimientos' ? 'border-b-4 border-indigo-600 text-indigo-600' : 'text-slate-400'}`}>Movimientos</button></div></div><div className="flex items-center gap-3 w-full md:w-auto"><div className="relative flex-grow md:w-64"><Icon name="Search" size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" /><input type="text" placeholder="Buscar ítem..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-bold focus:outline-none focus:border-indigo-500 transition-all shadow-sm" /></div>{inventoryTab === 'existencias' && (<div className="bg-white p-1 rounded-xl border border-slate-100 flex shadow-sm"><button onClick={() => setInventoryViewMode('grid')} className={`p-2 rounded-lg ${inventoryViewMode === 'grid' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-300'}`}><Icon name="LayoutGrid" size={20} /></button><button onClick={() => setInventoryViewMode('list')} className={`p-2 rounded-lg ${inventoryViewMode === 'list' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-300'}`}><Icon name="List" size={20} /></button></div>)}<Button icon="Plus" onClick={() => setModal({ open: true, type: 'product', data: null })}>Añadir Ítem</Button></div></div>
                                        {inventoryTab === 'existencias' ? (inventoryViewMode === 'grid' ? (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">{filteredProducts.map(p => { const isLow = p.trackStock && (parseInt(p.stock) <= parseInt(p.minStock)); return (<Card key={p.id} className={`p-6 hover:shadow-md transition-all flex flex-col justify-between ${isLow ? 'border-l-8 border-red-500 bg-red-50/10' : ''}`}><div><div className="flex justify-between items-start mb-4"><div className={`w-12 h-12 rounded-2xl flex items-center justify-center ${p.itemType === 'service' ? 'bg-blue-50 text-blue-600' : 'bg-amber-50 text-amber-600'}`}><Icon name={p.itemType === 'service' ? 'Zap' : 'Package'} /></div><div className="flex gap-2">{p.trackStock && (<button onClick={() => setModal({ open: true, type: 'stock_adjustment', data: p })} className="p-2 text-slate-300 hover:text-indigo-600" title="Ajustar Stock"><Icon name="Activity" size={18} /></button>)}<button onClick={() => setModal({ open: true, type: 'product', data: p })} className="p-2 text-slate-300 hover:text-indigo-600"><Icon name="Pencil" size={18} /></button><button onClick={() => deleteData('product', p.id)} className="p-2 text-slate-300 hover:text-red-500"><Icon name="Trash2" size={18} /></button></div></div><div className="mb-2"><p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{p.category || 'General'}</p><h4 className="font-bold text-lg text-slate-800 leading-tight">{p.name}</h4><p className="text-[11px] font-mono text-slate-400 mt-1">Cód: {p.code}</p>{p.description && (<p className="text-xs text-slate-500 mt-2 line-clamp-2 italic leading-relaxed">{p.description}</p>)}</div></div><div><div className="mt-4 pt-4 border-t border-slate-50 flex justify-between items-end"><div><p className="text-[9px] uppercase font-black text-slate-300">Existencia</p><p className={`text-xl font-black ${isLow ? 'text-red-600' : 'text-slate-800'}`}>{p.trackStock ? `${p.stock} ${p.unit}` : '∞'}</p></div><div className="text-right"><p className="text-[9px] uppercase font-black text-slate-300">Precio Venta</p><p className="text-xl font-black text-indigo-600">{formatCurrency(p.salePrice, p.currency || defaultCurrency)}</p></div></div>{isLow && (<div className="mt-4 p-2 bg-red-600 text-white text-[10px] font-black rounded-lg text-center uppercase animate-pulse">¡Alerta: Stock Bajo!</div>)}</div></Card>); })}</div>) : (<Card className="overflow-hidden"><table className="w-full text-left text-sm"><thead className="bg-slate-50 text-[10px] uppercase font-black text-slate-400"><tr><th className="p-4">Ítem</th><th className="p-4">Categoría</th><th className="p-4 text-center">Stock</th><th className="p-4 text-right">Costo Prom.</th><th className="p-4 text-right">Precio Venta</th><th className="p-4 text-center">Acciones</th></tr></thead><tbody className="divide-y divide-slate-100">{filteredProducts.map(p => { const isLow = p.trackStock && (parseInt(p.stock) <= parseInt(p.minStock)); return (<tr key={p.id} className={`hover:bg-slate-50 transition-colors ${isLow ? 'bg-red-50/20' : ''}`}><td className="p-4"><div><p className="font-bold text-slate-700">{p.name}</p><p className="text-[10px] font-mono text-slate-400">{p.code}</p>{p.description && <p className="text-[10px] text-slate-400 italic truncate max-w-xs">{p.description}</p>}</div></td><td className="p-4 text-slate-500 text-xs font-bold uppercase">{p.category || '-'}</td><td className="p-4 text-center"><span className={`font-black ${isLow ? 'text-red-600' : 'text-slate-700'}`}>{p.trackStock ? `${p.stock} ${p.unit}` : '∞'}</span></td><td className="p-4 text-right text-slate-500">{formatCurrency(p.averageCost, p.currency)}</td><td className="p-4 text-right font-black text-indigo-600">{formatCurrency(p.salePrice, p.currency)}</td><td className="p-4 text-center"><div className="flex justify-center gap-2">{p.trackStock && <button onClick={() => setModal({ open: true, type: 'stock_adjustment', data: p })} className="text-slate-300 hover:text-emerald-500"><Icon name="Activity" size={16}/></button>}<button onClick={() => setModal({ open: true, type: 'product', data: p })} className="text-slate-300 hover:text-indigo-600"><Icon name="Pencil" size={16}/></button><button onClick={() => deleteData('product', p.id)} className="text-slate-300 hover:text-red-500"><Icon name="Trash2" size={16}/></button></div></td></tr>); })}</tbody></table></Card>)) : (<Card className="overflow-hidden"><table className="w-full text-left text-sm"><thead className="bg-slate-50 text-[10px] uppercase font-black text-slate-400"><tr><th className="p-4">Fecha</th><th className="p-4">Producto</th><th className="p-4">Tipo</th><th className="p-4">Cantidad</th><th className="p-4">Razón</th><th className="p-4 text-right">Saldo Final</th></tr></thead><tbody className="divide-y divide-slate-100">{data.movements.map(m => (<tr key={m.id} className="hover:bg-slate-50"><td className="p-4 text-slate-500 font-mono text-xs">{m.date}</td><td className="p-4 font-bold">{m.productName}</td><td className="p-4"><Badge variant={m.type === 'ENTRADA' ? 'success' : 'danger'}>{m.type}</Badge></td><td className="p-4 font-black">{m.type === 'ENTRADA' ? '+' : '-'}{m.quantity}</td><td className="p-4 text-slate-500 italic text-xs">{m.reason}</td><td className="p-4 text-right font-bold text-slate-800">{m.stockAfter}</td></tr>))}{data.movements.length === 0 && <tr><td colSpan="6" className="p-8 text-center text-slate-400 italic">Sin movimientos registrados.</td></tr>}</tbody></table></Card>)}
                                        {filteredProducts.length === 0 && <p className="col-span-full text-center py-20 text-slate-400 italic">No hay productos registrados.</p>}
                                    </div>
                                )}

                                {view === 'settings' && (
                                    <div className="animate-slide-up space-y-8"><h2 className="text-4xl font-black italic text-indigo-950">Configuración</h2><div className="grid grid-cols-1 lg:grid-cols-2 gap-8"><Card className="p-8 border-l-8 border-indigo-600 shadow-xl h-fit"><div className="flex items-center gap-4 mb-8"><div className="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-100"><Icon name="Building" /></div><div><h4 className="font-black text-xl text-indigo-950">Perfil de la Empresa</h4><p className="text-sm text-slate-400 font-bold">Información pública y corporativa</p></div></div><form onSubmit={updateCompanyProfile} className="space-y-6"><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div className="space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-2">Nombre Comercial</label><input name="name" defaultValue={data.companyProfile?.name} className="w-full p-3 bg-slate-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none" required /></div><div className="space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-2">Moneda Predeterminada del Sistema</label><select name="defaultCurrency" defaultValue={data.companyProfile?.defaultCurrency || 'DOP'} className="w-full p-3 bg-indigo-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none">{Object.entries(CURRENCIES).map(([k,v]) => <option key={k} value={k}>{v.label}</option>)}</select></div><div className="space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-2">Representante</label><input name="rep" defaultValue={data.companyProfile?.rep} className="w-full p-3 bg-slate-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none" required /></div><div className="space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-2">RNC / Cédula</label><input name="rnc" defaultValue={data.companyProfile?.rnc} className="w-full p-3 bg-slate-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none" required /></div><div className="space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-2">Email</label><input name="email" defaultValue={data.companyProfile?.email} className="w-full p-3 bg-slate-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none" required /></div><div className="space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-2">Teléfono</label><input name="phone" defaultValue={data.companyProfile?.phone} className="w-full p-3 bg-slate-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none" required /></div><div className="md:col-span-2 space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-2">Dirección</label><input name="address" defaultValue={data.companyProfile?.address} className="w-full p-3 bg-slate-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none" required /></div><div className="md:col-span-2 space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-2">URL del Logo</label><input name="logo" defaultValue={data.companyProfile?.logo} className="w-full p-3 bg-slate-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none" /></div><div className="md:col-span-2 space-y-1 p-4 bg-red-50 rounded-2xl border border-red-100"><label className="text-[10px] font-black text-red-600 uppercase mb-2 block">PIN de Seguridad (Acceso Privado)</label><input name="staticPin" type="password" maxLength="4" defaultValue={data.companyProfile?.staticPin} className="w-full text-center text-2xl tracking-[1em] p-3 bg-white rounded-xl font-black border-2 border-transparent focus:border-red-600 outline-none shadow-sm" required /></div></div><Button type="submit" className="w-full py-4 uppercase font-black" loading={actionLoading}>Guardar Configuración Corporativa</Button></form></Card><div className="space-y-8"><Card className="p-8 border-l-8 border-emerald-600 shadow-xl"><div className="flex justify-between items-center mb-6"><div className="flex items-center gap-4"><div className="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-100"><Icon name="Percent" /></div><div><h4 className="font-black text-xl text-indigo-950">Impuestos</h4><p className="text-sm text-slate-400 font-bold">Tasas fiscales del sistema</p></div></div><Button variant="secondary" icon="Plus" onClick={() => setModal({ open: true, type: 'tax', data: null })}>Nuevo</Button></div><div className="space-y-2">{data.taxes.map(t => (<div key={t.id} className="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100"><span className="font-bold text-slate-700">{t.name}</span><div className="flex items-center gap-4"><span className="font-black text-emerald-600">{t.rate}%</span><button onClick={() => setModal({ open: true, type: 'tax', data: t })} className="text-indigo-300 hover:text-indigo-600"><Icon name="Pencil" size={16} /></button><button onClick={() => deleteData('tax', t.id)} className="text-red-300 hover:text-red-500"><Icon name="Trash2" size={16} /></button></div></div>))}{data.taxes.length === 0 && <p className="text-center py-4 text-slate-400 italic text-sm">No hay impuestos configurados.</p>}</div></Card></div></div></div>
                                )}

                            </div>
                        </div>
                    </main>

                    {/* Modales */}
                    <Modal isOpen={modal.open} onClose={() => setModal({ open: false, type: '', data: null })} title={modal.type === 'stock_adjustment' ? 'Ajuste de Stock' : modal.data ? `Editar ${modal.type === 'tax' ? 'Impuesto' : 'Registro'}` : `Nuevo Registro`}>
                        {modal.type === 'stock_adjustment' ? (<form onSubmit={adjustStock} className="space-y-6"><div className="bg-indigo-50 p-4 rounded-xl text-center"><p className="text-xs font-bold text-indigo-400 uppercase tracking-widest">Producto seleccionado</p><p className="text-lg font-black text-indigo-900 uppercase italic">{modal.data.name}</p><p className="text-sm font-bold text-indigo-600 mt-1">Stock Actual: {modal.data.stock} {modal.data.unit}</p></div><div><label className="text-[10px] font-black text-slate-400 uppercase ml-2">Tipo de Movimiento</label><select name="moveType" className="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-indigo-500" required><option value="ENTRADA">Entrada (+) - Compra / Ajuste</option><option value="SALIDA">Salida (-) - Merma / Ajuste</option></select></div><div className="grid grid-cols-2 gap-4"><div className="space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-2">Cantidad</label><input name="quantity" type="number" step="1" min="1" className="w-full p-4 bg-slate-50 rounded-2xl font-bold" placeholder="0" required /></div><div className="space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-2">Costo (Solo Entradas)</label><input name="cost" type="number" step="0.01" className="w-full p-4 bg-slate-50 rounded-2xl font-bold" placeholder="0.00" /></div></div><input name="reason" placeholder="Razón del ajuste (ej. Compra a suplidor, Error de conteo)" className="w-full p-4 bg-slate-50 rounded-2xl font-bold" required /><Button type="submit" className="w-full py-4 uppercase font-black" loading={actionLoading}>Procesar Ajuste</Button></form>) : (<form className="space-y-6" onSubmit={e => { e.preventDefault(); const fd = new FormData(e.target); saveData(modal.type, Object.fromEntries(fd.entries())); }}>{modal.data && <input type="hidden" name="id" value={modal.data.id} />}{modal.type === 'client' && (<div className="space-y-4"><input name="name" defaultValue={modal.data?.name} placeholder="Nombre Cliente / Empresa" className="w-full p-4 bg-slate-50 rounded-2xl font-bold" required /><select name="type" defaultValue={modal.data?.type || 'final'} className="w-full p-4 bg-slate-50 rounded-2xl font-bold">{Object.entries(CLIENT_TYPES).map(([k,v]) => <option key={k} value={k}>{v.label}</option>)}</select><div className="flex gap-4"><select name="docType" defaultValue={modal.data?.docType || 'rnc'} className="w-1/3 p-4 bg-slate-50 rounded-2xl font-bold">{Object.entries(DOC_TYPES).map(([k,v]) => <option key={k} value={k}>{v}</option>)}</select><input name="rnc" defaultValue={modal.data?.rnc} placeholder="Número Documento" className="w-2/3 p-4 bg-slate-50 rounded-2xl font-bold" required /></div><div className="flex gap-4"><select name="currency" defaultValue={modal.data?.currency || defaultCurrency} className="w-1/3 p-4 bg-slate-50 rounded-2xl font-bold">{Object.keys(CURRENCIES).map(k => <option key={k} value={k}>{k}</option>)}</select><input name="creditLimit" type="number" defaultValue={modal.data?.creditLimit || 0} placeholder="Límite Crédito" className="w-2/3 p-4 bg-slate-50 rounded-2xl font-bold" required /></div><input name="phone" defaultValue={modal.data?.phone} placeholder="Teléfono" className="w-full p-4 bg-slate-50 rounded-2xl font-bold" /><input name="email" defaultValue={modal.data?.email} placeholder="Correo electrónico" className="w-full p-4 bg-slate-50 rounded-2xl font-bold" /><input name="address" defaultValue={modal.data?.address} placeholder="Dirección" className="w-full p-4 bg-slate-50 rounded-2xl font-bold" /></div>)}{modal.type === 'product' && (<div className="space-y-4"><div className="flex gap-4"><label className="flex-1 cursor-pointer"><input type="radio" name="itemType" value="product" defaultChecked={modal.data?.itemType !== 'service'} className="sr-only peer" /><div className="p-3 rounded-xl border-2 text-center font-bold peer-checked:border-indigo-600 peer-checked:bg-indigo-50">Producto</div></label><label className="flex-1 cursor-pointer"><input type="radio" name="itemType" value="service" defaultChecked={modal.data?.itemType === 'service'} className="sr-only peer" /><div className="p-3 rounded-xl border-2 text-center font-bold peer-checked:border-indigo-600 peer-checked:bg-indigo-50">Servicio</div></label></div><div className="grid grid-cols-3 gap-4"><input name="code" defaultValue={modal.data?.code} placeholder="Código" className="w-full p-4 bg-slate-50 rounded-2xl font-bold" required /><input name="name" defaultValue={modal.data?.name} placeholder="Nombre del Ítem" className="col-span-2 w-full p-4 bg-slate-50 rounded-2xl font-bold" required /></div><div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-2 uppercase">Descripción detallada</label><textarea name="description" defaultValue={modal.data?.description} placeholder="Añada detalles adicionales..." className="w-full p-4 bg-slate-50 rounded-2xl font-bold min-h-[100px] outline-none border-2 border-transparent focus:border-indigo-500 transition-all" /></div><div className="grid grid-cols-2 gap-4"><input name="category" defaultValue={modal.data?.category} placeholder="Categoría" className="w-full p-4 bg-slate-50 rounded-2xl font-bold" /><input name="unit" defaultValue={modal.data?.unit || 'UND'} placeholder="Unidad (UND, LB, Gal)" className="w-full p-4 bg-slate-50 rounded-2xl font-bold" required /></div><div className="grid grid-cols-1 md:grid-cols-3 gap-4 bg-slate-50 p-4 rounded-2xl"><div className="md:col-span-1"><label className="text-[10px] font-black text-slate-400 block mb-1">Moneda Ítem</label><select name="currency" defaultValue={modal.data?.currency || defaultCurrency} className="w-full p-2 bg-white rounded-lg font-bold border-2 border-transparent focus:border-indigo-500">{Object.entries(CURRENCIES).map(([k,v]) => <option key={k} value={k}>{k}</option>)}</select></div><div><label className="text-[10px] font-black text-slate-400 block mb-1">Costo Inicial</label><input name="purchasePrice" type="number" step="0.01" defaultValue={modal.data?.purchasePrice || 0} className="w-full p-2 bg-white rounded-lg font-bold" required /></div><div><label className="text-[10px] font-black text-slate-400 block mb-1">Precio Venta</label><input name="salePrice" type="number" step="0.01" defaultValue={modal.data?.salePrice || 0} className="w-full p-2 bg-white rounded-lg font-bold text-indigo-600" required /></div></div><div className="grid grid-cols-2 gap-4"><div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-2">Stock Inicial</label><input name="stock" type="number" defaultValue={modal.data?.stock || 0} className="w-full p-4 bg-slate-50 rounded-2xl font-bold" /></div><div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-2">Mínimo (Alerta)</label><input name="minStock" type="number" defaultValue={modal.data?.minStock || 5} className="w-full p-4 bg-slate-50 rounded-2xl font-bold text-red-500" /></div></div><div className="flex items-center gap-2 p-2 ml-2"><input type="checkbox" name="trackStock" defaultChecked={modal.data?.trackStock !== false} className="w-4 h-4 accent-indigo-600" /><label className="text-xs font-bold text-slate-500">Controlar Inventario / Alertar</label></div></div>)}{modal.type === 'tax' && (<div className="space-y-4"><input name="name" defaultValue={modal.data?.name} className="w-full p-4 bg-slate-50 rounded-2xl font-bold" placeholder="Nombre (ej. ITBIS 18%)" required /><input name="rate" type="number" step="0.01" defaultValue={modal.data?.rate} className="w-full p-4 bg-slate-50 rounded-2xl font-bold" placeholder="Tasa % (ej. 18)" required /></div>)}<Button type="submit" loading={actionLoading} className="w-full py-4 uppercase font-black">Guardar Registro</Button></form>)}
                    </Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
